<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Table Tennis Analyzer ‚Äî Advanced Biomechanics Edition</title>
  <style>
    :root{--bg:#0b0b0d;--panel:#121216;--accent:#00eaff;--success:#4cffc1;--warning:#ffb347;--danger:#ff6b6b;--player1:#00ff78;--player2:#ff5050;--bio-wrist:#ff00ff;--bio-foot:#00ffff;--bio-torso:#ffff00}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#eee}
    .wrap{display:flex;gap:20px;padding:18px}
    .left{flex:1;position:relative;max-width:980px}
    .controls{margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls input[type="file"]{background:#1a1a1f;border:1px solid #333;padding:8px 12px;border-radius:6px;color:#eee}
    .controls button{background:var(--accent);color:#000;border:none;padding:8px 16px;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s}
    .controls button:hover{background:#00c8d9}
    .controls button:disabled{background:#333;color:#666;cursor:not-allowed}
    .controls button.secondary{background:#222;color:#eee;border:1px solid #333}
    .controls button.secondary:hover{background:#333}
    .controls button.danger{background:var(--danger);color:#fff}
    .controls button.active{background:var(--success);color:#000}
    video{width:100%;border-radius:8px;border:2px solid #222;background:#000;display:block}
    #overlay{position:absolute;left:0;top:0;pointer-events:none;border-radius:8px}
    #bio-overlay{position:absolute;left:0;top:0;pointer-events:none;border-radius:8px}
    
    /* Real-time feedback panel */
    #feedback-panel{position:absolute;top:10px;left:10px;right:10px;pointer-events:none;z-index:100}
    .feedback-card{background:rgba(0,0,0,0.85);border-radius:10px;padding:12px 16px;margin-bottom:8px;border-left:4px solid var(--accent);animation:slideIn 0.3s ease-out;backdrop-filter:blur(8px)}
    .feedback-card.wrist{border-left-color:var(--bio-wrist)}
    .feedback-card.foot{border-left-color:var(--bio-foot)}
    .feedback-card.torso{border-left-color:var(--bio-torso)}
    .feedback-card.stroke{border-left-color:var(--success)}
    .feedback-card .title{font-weight:700;font-size:13px;margin-bottom:4px;display:flex;align-items:center;gap:8px}
    .feedback-card .message{font-size:11px;color:#aaa;line-height:1.4}
    .feedback-card .metrics{display:flex;gap:10px;margin-top:6px;flex-wrap:wrap}
    .feedback-card .metric{background:#1a1a1f;padding:4px 8px;border-radius:4px;font-size:10px}
    .feedback-card .metric .label{color:#666;margin-right:4px}
    .feedback-card .metric .value{font-weight:600}
    .feedback-card .metric .value.good{color:var(--success)}
    .feedback-card .metric .value.warn{color:var(--warning)}
    .feedback-card .metric .value.poor{color:var(--danger)}
    @keyframes slideIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeOut{from{opacity:1}to{opacity:0}}
    .feedback-card.fade-out{animation:fadeOut 0.5s ease-out forwards}
    
    /* Dashboard */
    #dash-toggle{position:fixed;right:0;top:45%;transform:translateY(-50%);z-index:10000;background:var(--accent);color:#000;padding:12px 14px;border-radius:8px 0 0 8px;cursor:pointer;font-weight:700;box-shadow:-4px 0 12px rgba(0,234,255,0.3)}
    #dashboard{position:fixed;right:-440px;top:0;width:420px;height:100%;background:var(--panel);box-shadow:-8px 0 24px rgba(0,0,0,0.6);transition:right .3s;padding:18px;overflow:auto;z-index:9999}
    #dashboard.open{right:0}
    #dashboard::-webkit-scrollbar{width:6px}
    #dashboard::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
    
    h1{margin-top:0;font-size:1.6em;background:linear-gradient(90deg,var(--accent),var(--success));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    h2{margin:6px 0 12px 0;font-size:1.2em}
    h3{margin:14px 0 8px 0;font-size:1em;color:#9fb4b9}
    .small{font-size:13px;color:#bfc9d6}
    
    /* Biomechanics panel */
    .bio-panel{background:linear-gradient(135deg,#1a0a1a,#0a1a1a);border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid #2a1a3a}
    .bio-panel h4{margin:0 0 12px 0;font-size:13px;color:#b388ff;display:flex;align-items:center;gap:8px}
    .bio-section{background:#0a0a0c;border-radius:8px;padding:12px;margin-bottom:10px;border-left:3px solid #333}
    .bio-section.wrist{border-left-color:var(--bio-wrist)}
    .bio-section.foot{border-left-color:var(--bio-foot)}
    .bio-section.torso{border-left-color:var(--bio-torso)}
    .bio-section .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .bio-section .title{font-weight:600;font-size:12px;display:flex;align-items:center;gap:6px}
    .bio-section .title .icon{font-size:14px}
    .bio-section .score{font-size:18px;font-weight:700}
    .bio-section .score.excellent{color:var(--success)}
    .bio-section .score.good{color:var(--accent)}
    .bio-section .score.fair{color:var(--warning)}
    .bio-section .score.poor{color:var(--danger)}
    .bio-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .bio-metric{background:#111;padding:6px 8px;border-radius:4px}
    .bio-metric .label{font-size:9px;color:#666;margin-bottom:2px}
    .bio-metric .value{font-size:12px;font-weight:600;color:#fff}
    .bio-bar{height:4px;background:#1a1a1f;border-radius:2px;margin-top:4px;overflow:hidden}
    .bio-bar .fill{height:100%;border-radius:2px;transition:width .3s}
    
    /* Stroke stats */
    .stroke-stats{background:#0a0a0c;border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid #1a1a1f}
    .stroke-stats h4{margin:0 0 10px 0;font-size:13px;color:var(--accent)}
    .stroke-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .stroke-stat{text-align:center;background:#111;padding:8px;border-radius:6px}
    .stroke-stat .value{font-size:18px;font-weight:700;color:var(--accent)}
    .stroke-stat .label{font-size:9px;color:#666;margin-top:2px}
    
    /* Timeline */
    #timeline{background:#070708;border-radius:6px;padding:8px;max-height:280px;overflow:auto;border:1px solid #222}
    .event{padding:10px;border-bottom:1px solid #1a1a1f;color:#ddd;font-size:12px}
    .event:last-child{border-bottom:none}
    .event:hover{background:rgba(0,234,255,0.05)}
    .event .header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
    .event .player-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}
    .event .stroke-type{font-weight:700;flex:1}
    .event .time{color:#666;font-size:10px}
    .event .details{display:flex;flex-wrap:wrap;gap:6px}
    .event .tag{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:600}
    .event .tag.spin{background:rgba(76,255,193,0.15);color:var(--success)}
    .event .tag.spin.topspin{background:rgba(255,100,100,0.15);color:#ff6b6b}
    .event .tag.spin.backspin{background:rgba(100,150,255,0.15);color:#6b9fff}
    .event .tag.spin.sidespin{background:rgba(255,200,100,0.15);color:#ffc864}
    .event .tag.speed{background:rgba(0,234,255,0.15);color:var(--accent)}
    .event .tag.wrist{background:rgba(255,0,255,0.15);color:var(--bio-wrist)}
    .event .tag.power{background:rgba(255,255,0,0.15);color:var(--bio-torso)}
    .event .tag.conf{background:rgba(255,255,255,0.1);color:#888}
    
    /* Charts */
    .chart-container{background:#0a0a0c;border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid #1a1a1f}
    canvas.chart{background:transparent;border-radius:6px}
    
    /* Status bar */
    .status-bar{display:flex;align-items:center;gap:8px;margin-top:12px;padding:10px;background:#1a1a1f;border-radius:8px}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#666}
    .status-dot.active{background:var(--success);animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
    
    /* Settings panel */
    .settings-panel{background:#1a1a1f;border-radius:8px;padding:12px;margin-top:12px;border:1px solid #333}
    .settings-panel h4{margin:0 0 10px 0;font-size:13px;color:var(--accent)}
    .setting-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .setting-row label{flex:1;font-size:12px;color:#999}
    .setting-row input[type="range"]{flex:2}
    .setting-row input[type="checkbox"]{width:18px;height:18px}
    .setting-row span{width:40px;font-size:11px;color:var(--accent)}
    
    /* Bio overlay toggles */
    .bio-toggles{display:flex;gap:6px;margin-top:8px}
    .bio-toggle{flex:1;padding:6px 10px;border-radius:6px;font-size:11px;text-align:center;cursor:pointer;border:2px solid transparent;transition:all .2s}
    .bio-toggle.wrist{background:rgba(255,0,255,0.1);border-color:rgba(255,0,255,0.3);color:var(--bio-wrist)}
    .bio-toggle.foot{background:rgba(0,255,255,0.1);border-color:rgba(0,255,255,0.3);color:var(--bio-foot)}
    .bio-toggle.torso{background:rgba(255,255,0,0.1);border-color:rgba(255,255,0,0.3);color:var(--bio-torso)}
    .bio-toggle.active{border-color:currentColor;background:rgba(255,255,255,0.1)}
    
    .btn-group{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .btn-group button{flex:1;min-width:80px}
    
    .muted{color:#97a0ac;font-size:13px}
    
    .tabs{display:flex;gap:4px;margin-bottom:12px;background:#0a0a0c;padding:4px;border-radius:8px}
    .tab{flex:1;padding:8px;text-align:center;background:transparent;color:#666;border-radius:6px;font-size:11px;cursor:pointer;transition:all .2s;border:none}
    .tab.active{background:var(--accent);color:#000}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    @media(max-width:900px){
      .wrap{flex-direction:column}
      .left{max-width:100%}
      #dashboard{width:100%;right:-100%}
    }
  </style>
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div id="dash-toggle">üìä Analytics</div>
  <div id="dashboard" aria-hidden="true">
    <h2>Biomechanics Dashboard</h2>
    <div class="small">Advanced stroke & movement analysis</div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="strokes">üèì Strokes</button>
      <button class="tab" data-tab="biomechanics">ü¶¥ Bio</button>
      <button class="tab" data-tab="charts">üìà Charts</button>
    </div>

    <!-- Strokes Tab -->
    <div id="tab-strokes" class="tab-content active">
      <div class="stroke-stats">
        <h4>üèì Stroke Statistics</h4>
        <div class="stroke-grid">
          <div class="stroke-stat">
            <div class="value" id="total-strokes">0</div>
            <div class="label">Total Strokes</div>
          </div>
          <div class="stroke-stat">
            <div class="value" id="fh-count">0</div>
            <div class="label">Forehand</div>
          </div>
          <div class="stroke-stat">
            <div class="value" id="bh-count">0</div>
            <div class="label">Backhand</div>
          </div>
          <div class="stroke-stat">
            <div class="value" id="topspin-count">0</div>
            <div class="label">Topspin</div>
          </div>
          <div class="stroke-stat">
            <div class="value" id="backspin-count">0</div>
            <div class="label">Backspin</div>
          </div>
          <div class="stroke-stat">
            <div class="value" id="avg-speed">--</div>
            <div class="label">Avg Speed</div>
          </div>
        </div>
      </div>

      <h3>Event Timeline</h3>
      <div id="timeline"><div class="muted">Strokes will appear here during analysis...</div></div>
    </div>

    <!-- Biomechanics Tab -->
    <div id="tab-biomechanics" class="tab-content">
      <div class="bio-panel">
        <h4>üéØ Real-time Biomechanics</h4>
        
        <!-- Wrist Snap Section -->
        <div class="bio-section wrist">
          <div class="header">
            <div class="title"><span class="icon">üñêÔ∏è</span> Wrist Snap (Spin)</div>
            <div class="score good" id="wrist-score">--</div>
          </div>
          <div class="bio-metrics">
            <div class="bio-metric">
              <div class="label">Angular Velocity</div>
              <div class="value" id="wrist-angular-vel">-- ¬∞/s</div>
            </div>
            <div class="bio-metric">
              <div class="label">Spin Potential</div>
              <div class="value" id="wrist-spin">--</div>
            </div>
          </div>
          <div class="bio-bar"><div class="fill" id="wrist-bar" style="width:0%;background:var(--bio-wrist)"></div></div>
        </div>
        
        <!-- Footwork Section -->
        <div class="bio-section foot">
          <div class="header">
            <div class="title"><span class="icon">üëü</span> Footwork</div>
            <div class="score good" id="foot-score">--</div>
          </div>
          <div class="bio-metrics">
            <div class="bio-metric">
              <div class="label">Pattern</div>
              <div class="value" id="foot-pattern">--</div>
            </div>
            <div class="bio-metric">
              <div class="label">Balance</div>
              <div class="value" id="foot-balance">--</div>
            </div>
          </div>
          <div class="bio-bar"><div class="fill" id="foot-bar" style="width:0%;background:var(--bio-foot)"></div></div>
        </div>
        
        <!-- Torso/Hip Section -->
        <div class="bio-section torso">
          <div class="header">
            <div class="title"><span class="icon">üîÑ</span> Body Rotation</div>
            <div class="score good" id="torso-score">--</div>
          </div>
          <div class="bio-metrics">
            <div class="bio-metric">
              <div class="label">X-Factor</div>
              <div class="value" id="torso-xfactor">-- ¬∞</div>
            </div>
            <div class="bio-metric">
              <div class="label">Power Transfer</div>
              <div class="value" id="torso-power">--%</div>
            </div>
          </div>
          <div class="bio-bar"><div class="fill" id="torso-bar" style="width:0%;background:var(--bio-torso)"></div></div>
        </div>
      </div>

      <!-- Overlay Toggles -->
      <div style="margin-bottom:14px">
        <div class="small" style="margin-bottom:6px">Visual Overlays:</div>
        <div class="bio-toggles">
          <div class="bio-toggle wrist active" id="toggle-wrist">üñêÔ∏è Wrist</div>
          <div class="bio-toggle foot active" id="toggle-foot">üëü Feet</div>
          <div class="bio-toggle torso active" id="toggle-torso">üîÑ Torso</div>
        </div>
      </div>
    </div>

    <!-- Charts Tab -->
    <div id="tab-charts" class="tab-content">
      <h3>Stroke Distribution</h3>
      <div class="chart-container">
        <canvas id="strokeChart" class="chart" height="120"></canvas>
      </div>
      
      <h3>Spin Distribution</h3>
      <div class="chart-container">
        <canvas id="spinChart" class="chart" height="120"></canvas>
      </div>
      
      <h3>Speed Over Time</h3>
      <div class="chart-container">
        <canvas id="speedChart" class="chart" height="100"></canvas>
      </div>
    </div>

    <!-- Export -->
    <div class="btn-group" style="margin-top:18px">
      <button id="export-json" class="secondary">üìÑ JSON</button>
      <button id="export-pdf" class="secondary">üìë PDF</button>
      <button id="btn-reset" class="danger">üîÑ Reset</button>
    </div>
  </div>

  <div class="wrap">
    <div class="left">
      <h1>üèì Table Tennis Analyzer ‚Äî Biomechanics Edition</h1>
      <div class="controls">
        <input id="videoUpload" type="file" accept="video/*" />
        <button id="btn-start" disabled>‚ñ∂Ô∏è Start Analysis</button>
        <button id="btn-pause" class="secondary" disabled>‚è∏Ô∏è Pause</button>
        <button id="toggle-skeleton" class="secondary active">ü¶¥ Skeleton</button>
        <button id="toggle-bio-overlay" class="secondary active">üìê Bio Overlay</button>
      </div>

      <div id="videoContainer" style="position:relative;">
        <video id="video" controls></video>
        <canvas id="overlay"></canvas>
        <canvas id="bio-overlay"></canvas>
        <div id="feedback-panel"></div>
      </div>

      <div class="status-bar">
        <div class="status-dot" id="status-dot"></div>
        <span id="status">Upload a video to begin</span>
      </div>

      <div class="settings-panel">
        <h4>üéõÔ∏è Settings</h4>
        <div class="setting-row">
          <label>Stroke Sensitivity</label>
          <input type="range" id="sensitivity" min="1" max="100" value="50" />
          <span id="sensitivity-val">50</span>
        </div>
        <div class="setting-row">
          <label>Show Tips</label>
          <input type="checkbox" id="show-tips" checked />
        </div>
      </div>
    </div>
  </div>

<script>
/* ============================================
   CONFIGURATION
   ============================================ */
const CONFIG = {
  FPS: 30,
  STROKE_COOLDOWN_MS: 350,
  MIN_VELOCITY: 0.012,
  SMASH_VELOCITY: 0.07,
  LOOP_VELOCITY: 0.035,
  FEEDBACK_DURATION: 3500,
  
  WRIST_SNAP: { EXCELLENT: 700, GOOD: 450, FAIR: 250 },
  TORSO: { EXCELLENT_ROTATION: 40, GOOD_ROTATION: 25 }
};

/* ============================================
   STATE
   ============================================ */
const state = {
  sessionActive: false,
  showSkeleton: true,
  showBioOverlay: true,
  showTips: true,
  
  overlayToggles: { wrist: true, foot: true, torso: true },
  
  latestLandmarks: null,
  prevLandmarks: null,
  
  // Stroke tracking
  strokes: [],
  lastStrokeTime: 0,
  
  // Biomechanics
  biomechanics: {
    wrist: { angularVelocity: 0, spinPotential: 'Low', score: 0, history: [] },
    footwork: { pattern: 'None', balance: 0, score: 0, patterns: { crossover: 0, shuffle: 0, splitStep: 0, recovery: 0 } },
    torso: { hipRotation: 0, shoulderRotation: 0, xFactor: 0, powerTransfer: 0, score: 0 }
  },
  
  // Wrist history for analysis
  wristHistory: { R: [], L: [] },
  ankleHistory: { R: [], L: [] },
  shoulderHistory: [],
  hipHistory: [],
  
  prevWrist: { R: null, L: null },
  
  frameCount: 0,
  lastFeedbackTime: 0
};

/* ============================================
   DOM REFERENCES
   ============================================ */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const bioOverlay = document.getElementById('bio-overlay');
const overlayCtx = overlay.getContext('2d');
const bioCtx = bioOverlay.getContext('2d');
const statusEl = document.getElementById('status');
const statusDot = document.getElementById('status-dot');
const feedbackPanel = document.getElementById('feedback-panel');
const dashboard = document.getElementById('dashboard');
const timelineEl = document.getElementById('timeline');

/* ============================================
   CHARTS
   ============================================ */
const strokeChart = new Chart(document.getElementById('strokeChart').getContext('2d'), {
  type: 'bar',
  data: {
    labels: ['FH Loop', 'BH Loop', 'FH Drive', 'BH Drive', 'Smash', 'Block', 'Chop', 'Flip'],
    datasets: [{ label: 'Count', data: [0,0,0,0,0,0,0,0], backgroundColor: '#00eaff' }]
  },
  options: { animation: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#1a1a1f' }, ticks: { color: '#666' } }, x: { grid: { display: false }, ticks: { color: '#888', font: { size: 9 } } } } }
});

const spinChart = new Chart(document.getElementById('spinChart').getContext('2d'), {
  type: 'doughnut',
  data: {
    labels: ['Topspin', 'Backspin', 'Sidespin', 'Neutral'],
    datasets: [{ data: [0,0,0,0], backgroundColor: ['#ff6b6b', '#6b9fff', '#ffc864', '#888'] }]
  },
  options: { animation: false, plugins: { legend: { labels: { color: '#888', font: { size: 10 } } } } }
});

const speedChart = new Chart(document.getElementById('speedChart').getContext('2d'), {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Speed', data: [], borderColor: '#00eaff', backgroundColor: 'rgba(0,234,255,0.1)', fill: true, tension: 0.4 }] },
  options: { animation: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#1a1a1f' }, ticks: { color: '#666' } }, x: { display: false } } }
});

/* ============================================
   UTILITY FUNCTIONS
   ============================================ */
function calculateAngle(p1, p2, p3) {
  if (!p1 || !p2 || !p3) return 0;
  const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
  const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
  const dot = v1.x * v2.x + v1.y * v2.y;
  const mag = Math.sqrt(v1.x**2 + v1.y**2) * Math.sqrt(v2.x**2 + v2.y**2);
  if (mag === 0) return 0;
  return Math.acos(Math.min(1, Math.max(-1, dot / mag))) * 180 / Math.PI;
}

function calculateRotation(p1, p2) {
  if (!p1 || !p2) return 0;
  return Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
}

function getScoreClass(score) {
  if (score >= 80) return 'excellent';
  if (score >= 60) return 'good';
  if (score >= 40) return 'fair';
  return 'poor';
}

/* ============================================
   SPIN CLASSIFICATION
   ============================================ */
function classifySpin(wristDy, elbowAngle, angularVelocity, wristHistory) {
  // Analyze wrist movement pattern for spin type
  let spinType = 'Neutral';
  let spinDegree = 0;
  
  if (wristHistory.length < 3) return { type: spinType, degree: spinDegree };
  
  const recentY = wristHistory.slice(-5).map(w => w.y);
  const avgDy = recentY.length > 1 ? (recentY[recentY.length-1] - recentY[0]) / recentY.length : 0;
  
  // Check for lateral movement (sidespin)
  const recentX = wristHistory.slice(-5).map(w => w.x);
  const avgDx = recentX.length > 1 ? Math.abs(recentX[recentX.length-1] - recentX[0]) / recentX.length : 0;
  
  // Topspin: wrist moves upward with brush motion
  if (avgDy < -0.008 && angularVelocity > 200) {
    spinType = 'Topspin';
    spinDegree = Math.min(100, Math.round(angularVelocity / 8 + Math.abs(avgDy) * 3000));
  }
  // Backspin: wrist moves downward with slice motion
  else if (avgDy > 0.005 && elbowAngle > 100) {
    spinType = 'Backspin';
    spinDegree = Math.min(100, Math.round(angularVelocity / 10 + avgDy * 2500));
  }
  // Sidespin: significant lateral movement
  else if (avgDx > 0.012 && angularVelocity > 150) {
    spinType = 'Sidespin';
    spinDegree = Math.min(100, Math.round(angularVelocity / 9 + avgDx * 2000));
  }
  // Some spin present
  else if (angularVelocity > 300) {
    spinType = avgDy < 0 ? 'Topspin' : 'Backspin';
    spinDegree = Math.min(60, Math.round(angularVelocity / 12));
  }
  
  return { type: spinType, degree: Math.max(0, spinDegree) };
}

/* ============================================
   STROKE CLASSIFICATION
   ============================================ */
function classifyStroke(wrist, elbow, shoulder, velocity, elbowAngle, wristDy, spin) {
  const isForehand = elbow && wrist ? wrist.x > elbow.x : true;
  const side = isForehand ? 'FH' : 'BH';
  
  let strokeType = 'Push';
  let subtype = '';
  
  // Smash detection
  if (velocity > CONFIG.SMASH_VELOCITY && elbowAngle > 130 && wristDy > 0.01) {
    strokeType = 'Smash';
    subtype = '';
  }
  // Loop detection (upward brushing motion with speed)
  else if (velocity > CONFIG.LOOP_VELOCITY && wristDy < -0.005 && spin.type === 'Topspin') {
    strokeType = `${side} Loop`;
    subtype = spin.degree > 60 ? 'Heavy' : '';
  }
  // Drive detection (forward motion)
  else if (velocity > CONFIG.LOOP_VELOCITY * 0.8 && Math.abs(wristDy) < 0.01) {
    strokeType = `${side} Drive`;
  }
  // Chop detection (downward slice)
  else if (wristDy > 0.01 && spin.type === 'Backspin' && velocity < CONFIG.LOOP_VELOCITY) {
    strokeType = `${side} Chop`;
  }
  // Block detection (minimal movement)
  else if (velocity < CONFIG.MIN_VELOCITY * 2) {
    strokeType = 'Block';
  }
  // Flip detection (quick wrist action over table)
  else if (velocity > CONFIG.MIN_VELOCITY * 1.5 && elbowAngle < 90 && spin.degree > 30) {
    strokeType = 'Flip';
  }
  // Default to push/drive
  else {
    strokeType = velocity > CONFIG.LOOP_VELOCITY * 0.6 ? `${side} Drive` : `${side} Push`;
  }
  
  return { type: strokeType, subtype, side: isForehand ? 'FH' : 'BH' };
}

/* ============================================
   STROKE DETECTION & BIOMECHANICS
   ============================================ */
function detectStroke(landmarks, currentTime) {
  if (!landmarks || landmarks.length < 17) return null;
  
  const now = performance.now();
  if (now - state.lastStrokeTime < CONFIG.STROKE_COOLDOWN_MS) return null;
  
  const sensitivity = parseInt(document.getElementById('sensitivity').value) / 100;
  const velocityThreshold = CONFIG.MIN_VELOCITY * (1.5 - sensitivity);
  
  const RW = landmarks[16], RE = landmarks[14], RS = landmarks[12];
  const LW = landmarks[15], LE = landmarks[13], LS = landmarks[11];
  const LH = landmarks[23], RH = landmarks[24];
  const LA = landmarks[27], RA = landmarks[28];
  
  let detectedStroke = null;
  
  ['R', 'L'].forEach(side => {
    const wrist = side === 'R' ? RW : LW;
    const elbow = side === 'R' ? RE : LE;
    const shoulder = side === 'R' ? RS : LS;
    
    if (!wrist || !elbow || wrist.visibility < 0.5) return;
    
    const prev = state.prevWrist[side];
    if (!prev) {
      state.prevWrist[side] = { x: wrist.x, y: wrist.y, t: now };
      return;
    }
    
    const dx = wrist.x - prev.x;
    const dy = wrist.y - prev.y;
    const velocity = Math.sqrt(dx*dx + dy*dy);
    
    // Store wrist history
    state.wristHistory[side].push({ x: wrist.x, y: wrist.y, t: now, angle: calculateRotation(elbow, wrist) });
    if (state.wristHistory[side].length > 20) state.wristHistory[side].shift();
    
    state.prevWrist[side] = { x: wrist.x, y: wrist.y, t: now };
    
    if (velocity < velocityThreshold) return;
    
    // Calculate biomechanics
    const elbowAngle = calculateAngle(shoulder, elbow, wrist);
    
    // Wrist angular velocity
    const wristHist = state.wristHistory[side];
    let angularVelocity = 0;
    if (wristHist.length >= 3) {
      const recent = wristHist.slice(-4);
      let totalAngleChange = 0;
      for (let i = 1; i < recent.length; i++) {
        totalAngleChange += Math.abs(recent[i].angle - recent[i-1].angle);
      }
      const timeSpan = (recent[recent.length-1].t - recent[0].t) / 1000;
      angularVelocity = timeSpan > 0 ? totalAngleChange / timeSpan : 0;
    }
    
    // Classify spin
    const spin = classifySpin(dy, elbowAngle, angularVelocity, wristHist);
    
    // Classify stroke
    const strokeClass = classifyStroke(wrist, elbow, shoulder, velocity, elbowAngle, dy, spin);
    
    // Calculate torso rotation
    let xFactor = 0, powerTransfer = 0;
    if (LS && RS && LH && RH) {
      const shoulderRot = Math.abs(calculateRotation(LS, RS));
      const hipRot = Math.abs(calculateRotation(LH, RH));
      xFactor = Math.abs(shoulderRot - hipRot);
      
      // Store for power transfer calc
      state.shoulderHistory.push({ angle: shoulderRot, t: now });
      state.hipHistory.push({ angle: hipRot, t: now });
      if (state.shoulderHistory.length > 15) state.shoulderHistory.shift();
      if (state.hipHistory.length > 15) state.hipHistory.shift();
      
      // Calculate power transfer (hip leads shoulder)
      if (state.hipHistory.length >= 3) {
        let hipLeads = 0;
        for (let i = 1; i < Math.min(state.hipHistory.length, state.shoulderHistory.length); i++) {
          const hipChange = Math.abs(state.hipHistory[i].angle - state.hipHistory[i-1].angle);
          const shoulderChange = Math.abs(state.shoulderHistory[i].angle - state.shoulderHistory[i-1].angle);
          if (hipChange > shoulderChange * 0.4) hipLeads++;
        }
        powerTransfer = Math.min(100, Math.round(hipLeads / (state.hipHistory.length - 1) * 70 + xFactor * 1.5));
      }
    }
    
    // Footwork pattern
    let footPattern = 'Stationary';
    if (LA && RA && LA.visibility > 0.5 && RA.visibility > 0.5) {
      state.ankleHistory.L.push({ x: LA.x, y: LA.y, t: now });
      state.ankleHistory.R.push({ x: RA.x, y: RA.y, t: now });
      if (state.ankleHistory.L.length > 15) state.ankleHistory.L.shift();
      if (state.ankleHistory.R.length > 15) state.ankleHistory.R.shift();
      
      if (state.ankleHistory.L.length >= 5) {
        const lHist = state.ankleHistory.L;
        const rHist = state.ankleHistory.R;
        const lMove = Math.abs(lHist[lHist.length-1].x - lHist[0].x);
        const rMove = Math.abs(rHist[rHist.length-1].x - rHist[0].x);
        
        if (lMove > 0.05 || rMove > 0.05) {
          if (Math.sign(lHist[lHist.length-1].x - lHist[0].x) === Math.sign(rHist[rHist.length-1].x - rHist[0].x)) {
            footPattern = 'Shuffle';
            state.biomechanics.footwork.patterns.shuffle++;
          } else {
            footPattern = 'Split Step';
            state.biomechanics.footwork.patterns.splitStep++;
          }
        }
      }
    }
    
    // Calculate scores
    const wristScore = Math.min(100, Math.round(angularVelocity / 8 + velocity * 500));
    const torsoScore = Math.min(100, Math.round(xFactor * 2 + powerTransfer * 0.5));
    const footScore = footPattern !== 'Stationary' ? 75 : 50;
    
    // Confidence
    const confidence = Math.min(0.95, velocity / 0.08 + (180 - elbowAngle) / 300 + (angularVelocity / 1000));
    
    detectedStroke = {
      type: strokeClass.type,
      subtype: strokeClass.subtype,
      side: strokeClass.side,
      spin: spin,
      velocity: velocity * 1000,
      elbowAngle: Math.round(elbowAngle),
      angularVelocity: Math.round(angularVelocity),
      xFactor: Math.round(xFactor),
      powerTransfer,
      footPattern,
      wristScore,
      torsoScore,
      footScore,
      confidence: Math.max(0.3, confidence),
      timestamp: currentTime,
      t: now
    };
    
    // Update biomechanics state
    state.biomechanics.wrist = { angularVelocity: Math.round(angularVelocity), spinPotential: spin.degree > 60 ? 'High' : spin.degree > 30 ? 'Medium' : 'Low', score: wristScore };
    state.biomechanics.torso = { xFactor: Math.round(xFactor), powerTransfer, score: torsoScore };
    state.biomechanics.footwork = { ...state.biomechanics.footwork, pattern: footPattern, score: footScore };
  });
  
  if (detectedStroke) {
    state.lastStrokeTime = now;
    state.strokes.push(detectedStroke);
    if (state.strokes.length > 500) state.strokes.shift();
    
    // Add to timeline
    addTimelineEvent(detectedStroke);
    
    // Show feedback
    if (state.showTips && now - state.lastFeedbackTime > 2000) {
      showStrokeFeedback(detectedStroke);
      state.lastFeedbackTime = now;
    }
    
    statusEl.textContent = `${detectedStroke.type} ‚Ä¢ ${detectedStroke.spin.type} ${detectedStroke.spin.degree}%`;
  }
  
  return detectedStroke;
}

/* ============================================
   TIMELINE
   ============================================ */
function addTimelineEvent(stroke) {
  const spinClass = stroke.spin.type.toLowerCase();
  const playerColor = stroke.side === 'FH' ? 'var(--player1)' : 'var(--player2)';
  
  const eventHtml = `
    <div class="event">
      <div class="header">
        <div class="player-dot" style="background:${playerColor}"></div>
        <div class="stroke-type">${stroke.type}${stroke.subtype ? ' ' + stroke.subtype : ''}</div>
        <div class="time">${stroke.timestamp.toFixed(2)}s</div>
      </div>
      <div class="details">
        <span class="tag spin ${spinClass}">${stroke.spin.type} ${stroke.spin.degree}%</span>
        <span class="tag speed">Speed: ${stroke.velocity.toFixed(0)}</span>
        <span class="tag wrist">Wrist: ${stroke.angularVelocity}¬∞/s</span>
        <span class="tag power">Power: ${stroke.powerTransfer}%</span>
        <span class="tag conf">${(stroke.confidence * 100).toFixed(0)}%</span>
      </div>
    </div>
  `;
  
  // Clear placeholder if first event
  if (state.strokes.length === 1) {
    timelineEl.innerHTML = '';
  }
  
  timelineEl.insertAdjacentHTML('afterbegin', eventHtml);
  
  // Keep max 50 events in DOM
  while (timelineEl.children.length > 50) {
    timelineEl.lastChild.remove();
  }
}

/* ============================================
   FEEDBACK
   ============================================ */
function showStrokeFeedback(stroke) {
  const card = document.createElement('div');
  card.className = 'feedback-card stroke';
  
  let message = '';
  if (stroke.spin.degree > 70) {
    message = `Excellent ${stroke.spin.type.toLowerCase()} generation!`;
  } else if (stroke.powerTransfer > 70) {
    message = 'Great body rotation and power transfer!';
  } else if (stroke.angularVelocity > 500) {
    message = 'Nice wrist snap for spin!';
  } else {
    message = `${stroke.type} detected with ${stroke.spin.type.toLowerCase()}.`;
  }
  
  card.innerHTML = `
    <div class="title">üèì ${stroke.type}</div>
    <div class="message">${message}</div>
    <div class="metrics">
      <div class="metric"><span class="label">Spin:</span><span class="value ${stroke.spin.degree > 50 ? 'good' : ''}">${stroke.spin.type} ${stroke.spin.degree}%</span></div>
      <div class="metric"><span class="label">Power:</span><span class="value ${stroke.powerTransfer > 60 ? 'good' : ''}">${stroke.powerTransfer}%</span></div>
    </div>
  `;
  
  feedbackPanel.appendChild(card);
  
  setTimeout(() => {
    card.classList.add('fade-out');
    setTimeout(() => card.remove(), 500);
  }, CONFIG.FEEDBACK_DURATION);
  
  while (feedbackPanel.children.length > 2) {
    feedbackPanel.firstChild.remove();
  }
}

/* ============================================
   RENDERING
   ============================================ */
function renderSkeleton(landmarks, w, h) {
  overlayCtx.clearRect(0, 0, w, h);
  if (!state.showSkeleton || !landmarks) return;
  
  const CONNECTIONS = [[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[24,26],[25,27],[26,28]];
  
  overlayCtx.strokeStyle = 'rgba(0,255,120,0.7)';
  overlayCtx.lineWidth = 2;
  
  CONNECTIONS.forEach(([a, b]) => {
    const pa = landmarks[a], pb = landmarks[b];
    if (pa && pb && pa.visibility > 0.3 && pb.visibility > 0.3) {
      overlayCtx.beginPath();
      overlayCtx.moveTo(pa.x * w, pa.y * h);
      overlayCtx.lineTo(pb.x * w, pb.y * h);
      overlayCtx.stroke();
    }
  });
  
  [11,12,13,14,15,16,23,24,25,26,27,28].forEach(i => {
    const p = landmarks[i];
    if (p && p.visibility > 0.3) {
      overlayCtx.fillStyle = 'rgba(0,255,120,0.9)';
      overlayCtx.beginPath();
      overlayCtx.arc(p.x * w, p.y * h, 4, 0, Math.PI * 2);
      overlayCtx.fill();
    }
  });
}

function renderBioOverlay(landmarks, w, h) {
  bioCtx.clearRect(0, 0, w, h);
  if (!state.showBioOverlay || !landmarks) return;
  
  const RW = landmarks[16], RE = landmarks[14], RS = landmarks[12];
  const LW = landmarks[15], LE = landmarks[13], LS = landmarks[11];
  const LA = landmarks[27], RA = landmarks[28];
  const LH = landmarks[23], RH = landmarks[24];
  
  // Wrist overlay
  if (state.overlayToggles.wrist) {
    [{ w: RW, e: RE }, { w: LW, e: LE }].forEach(({ w: wrist, e: elbow }) => {
      if (!wrist || !elbow || wrist.visibility < 0.5) return;
      
      bioCtx.strokeStyle = 'rgba(255,0,255,0.8)';
      bioCtx.lineWidth = 3;
      bioCtx.shadowColor = 'rgba(255,0,255,0.5)';
      bioCtx.shadowBlur = 8;
      bioCtx.beginPath();
      bioCtx.moveTo(elbow.x * w, elbow.y * h);
      bioCtx.lineTo(wrist.x * w, wrist.y * h);
      bioCtx.stroke();
      bioCtx.shadowBlur = 0;
      
      bioCtx.fillStyle = '#ff00ff';
      bioCtx.beginPath();
      bioCtx.arc(wrist.x * w, wrist.y * h, 6, 0, Math.PI * 2);
      bioCtx.fill();
      
      // Angular velocity indicator
      if (state.biomechanics.wrist.angularVelocity > 100) {
        const radius = 20 + state.biomechanics.wrist.angularVelocity / 50;
        bioCtx.strokeStyle = `rgba(255,0,255,${Math.min(1, state.biomechanics.wrist.angularVelocity / 600)})`;
        bioCtx.lineWidth = 2;
        bioCtx.beginPath();
        bioCtx.arc(wrist.x * w, wrist.y * h, radius, 0, Math.PI * 2);
        bioCtx.stroke();
      }
    });
  }
  
  // Footwork overlay
  if (state.overlayToggles.foot && LA && RA && LA.visibility > 0.5 && RA.visibility > 0.5) {
    bioCtx.strokeStyle = 'rgba(0,255,255,0.7)';
    bioCtx.lineWidth = 2;
    bioCtx.setLineDash([5, 5]);
    bioCtx.beginPath();
    bioCtx.moveTo(LA.x * w, LA.y * h);
    bioCtx.lineTo(RA.x * w, RA.y * h);
    bioCtx.stroke();
    bioCtx.setLineDash([]);
    
    [LA, RA].forEach(ankle => {
      bioCtx.fillStyle = '#00ffff';
      bioCtx.beginPath();
      bioCtx.arc(ankle.x * w, ankle.y * h, 6, 0, Math.PI * 2);
      bioCtx.fill();
    });
  }
  
  // Torso overlay
  if (state.overlayToggles.torso && LS && RS && LH && RH) {
    bioCtx.strokeStyle = 'rgba(255,255,0,0.7)';
    bioCtx.lineWidth = 3;
    bioCtx.beginPath();
    bioCtx.moveTo(LS.x * w, LS.y * h);
    bioCtx.lineTo(RS.x * w, RS.y * h);
    bioCtx.stroke();
    
    bioCtx.strokeStyle = 'rgba(255,200,0,0.6)';
    bioCtx.lineWidth = 2;
    bioCtx.beginPath();
    bioCtx.moveTo(LH.x * w, LH.y * h);
    bioCtx.lineTo(RH.x * w, RH.y * h);
    bioCtx.stroke();
    
    // X-Factor indicator
    if (state.biomechanics.torso.xFactor > 10) {
      const cx = (LS.x + RS.x + LH.x + RH.x) / 4 * w;
      const cy = (LS.y + RS.y + LH.y + RH.y) / 4 * h;
      bioCtx.fillStyle = 'rgba(0,0,0,0.6)';
      bioCtx.fillRect(cx - 25, cy - 10, 50, 20);
      bioCtx.fillStyle = '#ffff00';
      bioCtx.font = 'bold 11px Inter, Arial';
      bioCtx.textAlign = 'center';
      bioCtx.fillText(`X:${state.biomechanics.torso.xFactor}¬∞`, cx, cy + 4);
      bioCtx.textAlign = 'left';
    }
  }
}

/* ============================================
   MEDIAPIPE POSE
   ============================================ */
const pose = new Pose({
  locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  enableSegmentation: false,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

pose.onResults((results) => {
  state.prevLandmarks = state.latestLandmarks;
  state.latestLandmarks = results.poseLandmarks || null;
});

/* ============================================
   MAIN LOOP
   ============================================ */
async function analyzeFrame() {
  if (video.paused || video.ended || !state.sessionActive) {
    requestAnimationFrame(analyzeFrame);
    return;
  }
  
  state.frameCount++;
  
  const vw = video.videoWidth || 640;
  const vh = video.videoHeight || 480;
  
  if (overlay.width !== vw) {
    overlay.width = vw;
    overlay.height = vh;
    bioOverlay.width = vw;
    bioOverlay.height = vh;
  }
  
  try {
    await pose.send({ image: video });
    
    const landmarks = state.latestLandmarks;
    
    // Detect strokes
    detectStroke(landmarks, video.currentTime);
    
    // Render overlays
    renderSkeleton(landmarks, vw, vh);
    renderBioOverlay(landmarks, vw, vh);
    
  } catch (err) {
    console.warn('Analysis error:', err);
  }
  
  requestAnimationFrame(analyzeFrame);
}

/* ============================================
   UI REFRESH
   ============================================ */
function refreshUI() {
  const bio = state.biomechanics;
  
  // Wrist
  document.getElementById('wrist-score').textContent = bio.wrist.score || '--';
  document.getElementById('wrist-score').className = `score ${getScoreClass(bio.wrist.score)}`;
  document.getElementById('wrist-angular-vel').textContent = `${bio.wrist.angularVelocity || '--'} ¬∞/s`;
  document.getElementById('wrist-spin').textContent = bio.wrist.spinPotential || '--';
  document.getElementById('wrist-bar').style.width = `${bio.wrist.score || 0}%`;
  
  // Footwork
  document.getElementById('foot-score').textContent = bio.footwork.score || '--';
  document.getElementById('foot-score').className = `score ${getScoreClass(bio.footwork.score)}`;
  document.getElementById('foot-pattern').textContent = bio.footwork.pattern || '--';
  document.getElementById('foot-balance').textContent = `${bio.footwork.score || '--'}%`;
  document.getElementById('foot-bar').style.width = `${bio.footwork.score || 0}%`;
  
  // Torso
  document.getElementById('torso-score').textContent = bio.torso.score || '--';
  document.getElementById('torso-score').className = `score ${getScoreClass(bio.torso.score)}`;
  document.getElementById('torso-xfactor').textContent = `${bio.torso.xFactor || '--'}¬∞`;
  document.getElementById('torso-power').textContent = `${bio.torso.powerTransfer || '--'}%`;
  document.getElementById('torso-bar').style.width = `${bio.torso.score || 0}%`;
  
  // Stroke stats
  const strokes = state.strokes;
  document.getElementById('total-strokes').textContent = strokes.length;
  document.getElementById('fh-count').textContent = strokes.filter(s => s.side === 'FH').length;
  document.getElementById('bh-count').textContent = strokes.filter(s => s.side === 'BH').length;
  document.getElementById('topspin-count').textContent = strokes.filter(s => s.spin.type === 'Topspin').length;
  document.getElementById('backspin-count').textContent = strokes.filter(s => s.spin.type === 'Backspin').length;
  
  const avgSpeed = strokes.length > 0 ? strokes.reduce((a, s) => a + s.velocity, 0) / strokes.length : 0;
  document.getElementById('avg-speed').textContent = avgSpeed > 0 ? avgSpeed.toFixed(0) : '--';
  
  // Update charts
  updateCharts();
}

function updateCharts() {
  const strokes = state.strokes;
  
  // Stroke distribution
  const strokeTypes = ['FH Loop', 'BH Loop', 'FH Drive', 'BH Drive', 'Smash', 'Block', 'Chop', 'Flip'];
  const strokeCounts = strokeTypes.map(t => strokes.filter(s => s.type.includes(t.split(' ')[0]) && s.type.includes(t.split(' ')[1] || '')).length);
  strokeChart.data.datasets[0].data = strokeCounts;
  strokeChart.update('none');
  
  // Spin distribution
  const spinCounts = [
    strokes.filter(s => s.spin.type === 'Topspin').length,
    strokes.filter(s => s.spin.type === 'Backspin').length,
    strokes.filter(s => s.spin.type === 'Sidespin').length,
    strokes.filter(s => s.spin.type === 'Neutral').length
  ];
  spinChart.data.datasets[0].data = spinCounts;
  spinChart.update('none');
  
  // Speed trend
  const recentSpeeds = strokes.slice(-30).map(s => s.velocity);
  speedChart.data.labels = recentSpeeds.map((_, i) => i + 1);
  speedChart.data.datasets[0].data = recentSpeeds;
  speedChart.update('none');
}

setInterval(refreshUI, 250);

/* ============================================
   EVENT LISTENERS
   ============================================ */
document.getElementById('dash-toggle').addEventListener('click', () => dashboard.classList.toggle('open'));

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
  });
});

['wrist', 'foot', 'torso'].forEach(type => {
  document.getElementById(`toggle-${type}`).addEventListener('click', (e) => {
    state.overlayToggles[type] = !state.overlayToggles[type];
    e.target.classList.toggle('active', state.overlayToggles[type]);
  });
});

document.getElementById('videoUpload').addEventListener('change', (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  video.src = URL.createObjectURL(file);
  document.getElementById('btn-start').disabled = false;
  statusEl.textContent = 'Video loaded. Click Start.';
});

document.getElementById('btn-start').addEventListener('click', () => {
  state.sessionActive = true;
  statusDot.classList.add('active');
  video.play();
  analyzeFrame();
  statusEl.textContent = 'Analyzing...';
});

document.getElementById('btn-pause').addEventListener('click', () => {
  if (video.paused) { video.play(); statusEl.textContent = 'Analyzing...'; }
  else { video.pause(); statusEl.textContent = 'Paused'; }
});

document.getElementById('toggle-skeleton').addEventListener('click', (e) => {
  state.showSkeleton = !state.showSkeleton;
  e.target.classList.toggle('active', state.showSkeleton);
});

document.getElementById('toggle-bio-overlay').addEventListener('click', (e) => {
  state.showBioOverlay = !state.showBioOverlay;
  e.target.classList.toggle('active', state.showBioOverlay);
});

document.getElementById('sensitivity').addEventListener('input', (e) => {
  document.getElementById('sensitivity-val').textContent = e.target.value;
});

document.getElementById('show-tips').addEventListener('change', (e) => {
  state.showTips = e.target.checked;
});

document.getElementById('btn-reset').addEventListener('click', () => {
  if (confirm('Reset session?')) {
    video.pause();
    video.currentTime = 0;
    state.sessionActive = false;
    state.strokes = [];
    state.wristHistory = { R: [], L: [] };
    state.ankleHistory = { R: [], L: [] };
    state.shoulderHistory = [];
    state.hipHistory = [];
    state.prevWrist = { R: null, L: null };
    state.biomechanics.footwork.patterns = { crossover: 0, shuffle: 0, splitStep: 0, recovery: 0 };
    timelineEl.innerHTML = '<div class="muted">Strokes will appear here during analysis...</div>';
    feedbackPanel.innerHTML = '';
    statusDot.classList.remove('active');
    statusEl.textContent = 'Session reset';
    refreshUI();
  }
});

video.addEventListener('loadedmetadata', () => {
  overlay.width = video.videoWidth;
  overlay.height = video.videoHeight;
  bioOverlay.width = video.videoWidth;
  bioOverlay.height = video.videoHeight;
  document.getElementById('btn-start').disabled = false;
  document.getElementById('btn-pause').disabled = false;
});

video.addEventListener('ended', () => {
  statusEl.textContent = 'Video ended';
  statusDot.classList.remove('active');
});

// Export
document.getElementById('export-json').addEventListener('click', () => {
  const data = { strokes: state.strokes, biomechanics: state.biomechanics };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tt_analysis.json'; a.click();
});

document.getElementById('export-pdf').addEventListener('click', () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  doc.setFontSize(18); doc.setTextColor(0, 200, 220);
  doc.text('Table Tennis Analysis Report', 40, 40);
  doc.setFontSize(11); doc.setTextColor(0);
  let y = 70;
  doc.text(`Total Strokes: ${state.strokes.length}`, 40, y); y += 15;
  doc.text(`Topspin: ${state.strokes.filter(s => s.spin.type === 'Topspin').length}`, 40, y); y += 15;
  doc.text(`Backspin: ${state.strokes.filter(s => s.spin.type === 'Backspin').length}`, 40, y); y += 25;
  state.strokes.slice(-15).forEach(s => {
    doc.text(`${s.timestamp.toFixed(2)}s - ${s.type} ‚Ä¢ ${s.spin.type} ${s.spin.degree}%`, 40, y);
    y += 12;
  });
  doc.save('tt_analysis.pdf');
});

statusEl.textContent = 'Upload a video to begin';
</script>
<p style="width: 65%">Please note that this product is still in development and may not be fully functional. 
  It is our desire that you share your thoughts and interests around the product via the 
  <b style="color:#00ff78">feedback form on the forwarding page</b> for continuous improvement purposes. You may also wish to indicate your interest to support us.</p>
</body>
</html>