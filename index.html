<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Table Tennis Analyzer ‚Äî Multi-Player Mode</title>
  <style>
    :root{--bg:#0b0b0d;--panel:#121216;--accent:#00eaff;--success:#4cffc1;--warning:#ffb347;--danger:#ff6b6b;--player1:#00eaff;--player2:#ff6b9d}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#eee}
    .wrap{display:flex;gap:20px;padding:18px;min-height:100vh}
    .left{flex:1;max-width:calc(100% - 420px)}
    .controls{margin-bottom:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .controls input[type="file"]{background:#1a1a1f;border:1px solid #333;padding:8px 12px;border-radius:6px;color:#eee}
    .controls button{background:var(--accent);color:#000;border:none;padding:8px 16px;border-radius:6px;font-weight:600;transition:all .2s}
    .controls button:hover{background:#00c8d9;transform:translateY(-1px)}
    .controls button:disabled{background:#333;color:#666;cursor:not-allowed;transform:none}
    .controls .mode-toggle{display:flex;background:#1a1a1f;border-radius:8px;padding:3px;border:1px solid #333}
    .controls .mode-toggle button{background:transparent;color:#888;padding:6px 12px;font-size:12px}
    .controls .mode-toggle button.active{background:var(--accent);color:#000}
    .video-container{position:relative;display:inline-block;width:100%}
    video{width:100%;max-width:920px;border-radius:8px;border:2px solid #222;background:#000}
    #overlay-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;border-radius:8px}
    
    #player-detect-modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:20000;display:none;align-items:center;justify-content:center}
    #player-detect-modal.active{display:flex}
    .modal-content{background:var(--panel);border-radius:16px;padding:30px;max-width:750px;width:95%;border:1px solid #333;box-shadow:0 20px 60px rgba(0,0,0,0.5);max-height:90vh;overflow-y:auto}
    .modal-content h2{margin-top:0;color:var(--accent);font-size:1.4em}
    .modal-content p{color:#999;line-height:1.6;margin-bottom:20px}
    
    .scanning-state{text-align:center;padding:40px 20px}
    .scanning-state .spinner{width:60px;height:60px;border:4px solid #333;border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .scanning-state h3{color:#fff;margin:0 0 10px 0}
    .scanning-state p{color:#888;margin:0}
    .scan-progress{margin-top:15px;font-size:12px;color:var(--accent)}
    
    .detection-results{display:none}
    .detection-results.active{display:block}
    
    .video-preview-container{position:relative;background:#000;border-radius:12px;overflow:hidden;margin-bottom:20px}
    .video-preview-container video{width:100%;display:block}
    .video-preview-container canvas{position:absolute;top:0;left:0;width:100%;height:100%}
    
    .player-tags-info{background:#1a1a1f;border-radius:10px;padding:16px;margin-bottom:20px}
    .player-tags-info h4{margin:0 0 12px 0;color:#fff;font-size:14px}
    .detected-players-list{display:flex;flex-wrap:wrap;gap:10px}
    .player-tag-item{display:flex;align-items:center;gap:8px;background:#0a0a0c;padding:10px 14px;border-radius:8px;border:2px solid #333;cursor:pointer;transition:all .2s}
    .player-tag-item:hover{border-color:var(--accent)}
    .player-tag-item.selected{border-color:var(--success);background:#0a1a0f}
    .player-tag-badge{width:32px;height:32px;background:var(--accent);color:#000;font-weight:700;font-size:16px;display:flex;align-items:center;justify-content:center;border-radius:6px}
    .player-tag-desc{font-size:13px;color:#ccc}
    
    .multi-player-select{background:#1a1a1f;border-radius:10px;padding:16px;margin-bottom:20px}
    .multi-player-select h4{margin:0 0 12px 0;color:#fff;font-size:14px}
    .player-select-row{display:flex;gap:16px;margin-bottom:12px;align-items:center}
    .player-select-row .player-label{width:80px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
    .player-select-row .player-label .dot{width:12px;height:12px;border-radius:50%}
    .player-select-row .player-label.p1 .dot{background:var(--player1)}
    .player-select-row .player-label.p2 .dot{background:var(--player2)}
    .player-select-row input{flex:1;max-width:80px;padding:10px;border-radius:8px;border:2px solid #333;background:#0a0a0c;color:#eee;font-size:16px;font-weight:600;text-transform:uppercase;text-align:center}
    .player-select-row input:focus{outline:none;border-color:var(--accent)}
    .player-select-row .player-name{flex:1}
    .player-select-row .player-name input{max-width:none;text-align:left;font-size:14px;font-weight:400;text-transform:none}
    
    .modal-actions{display:flex;gap:12px;margin-top:24px}
    .modal-actions button{flex:1;padding:14px;font-size:15px}
    
    .no-players-detected{text-align:center;padding:30px;background:#1a1a1f;border-radius:10px}
    .no-players-detected .icon{font-size:48px;margin-bottom:10px}
    .no-players-detected h4{color:var(--warning);margin:0 0 8px 0}
    .no-players-detected p{color:#888;margin:0;font-size:13px}
    
    #dash-toggle{position:fixed;right:0;top:45%;transform:translateY(-50%);z-index:10000;background:var(--accent);color:#000;padding:12px 14px;border-radius:8px 0 0 8px;cursor:pointer;font-weight:700;transition:all .2s;box-shadow:-4px 0 12px rgba(0,234,255,0.3)}
    #dash-toggle:hover{padding-right:20px}
    #dashboard{position:fixed;right:-440px;top:0;width:420px;height:100%;background:var(--panel);box-shadow:-8px 0 24px rgba(0,0,0,0.6);transition:right .35s cubic-bezier(0.4,0,0.2,1);padding:18px;overflow:auto;z-index:9999}
    #dashboard.open{right:0}
    #dashboard::-webkit-scrollbar{width:6px}
    #dashboard::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
    
    h1{margin-top:0;font-size:1.8em;background:linear-gradient(90deg,var(--accent),var(--success));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    h2{margin:6px 0 12px 0;font-size:1.3em}
    h3{margin:14px 0 8px 0;font-size:1em;color:#9fb4b9}
    .small{font-size:13px;color:#bfc9d6}
    
    .tracked-players{display:flex;gap:10px;margin-bottom:14px}
    .tracked-player-card{flex:1;background:#1a1a1f;border-radius:10px;padding:12px;border:2px solid #333}
    .tracked-player-card.p1{border-color:var(--player1)}
    .tracked-player-card.p2{border-color:var(--player2)}
    .tracked-player-card .header{display:flex;align-items:center;gap:8px}
    .tracked-player-card .tag{width:28px;height:28px;font-weight:700;font-size:14px;display:flex;align-items:center;justify-content:center;border-radius:6px;color:#000}
    .tracked-player-card.p1 .tag{background:var(--player1)}
    .tracked-player-card.p2 .tag{background:var(--player2)}
    .tracked-player-card .name{font-size:13px;font-weight:600;color:#fff}
    .tracked-player-card .position{font-size:11px;color:#666}
    .change-btn{margin-left:auto;background:#222;color:#666;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;border:1px solid #333}
    .change-btn:hover{border-color:var(--accent);color:var(--accent)}
    
    .comparison-section{background:#0a0a0c;border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid #1a1a1f}
    .comparison-section h4{margin:0 0 12px 0;font-size:13px;color:#888}
    .comparison-row{display:flex;align-items:center;margin-bottom:10px}
    .comparison-row:last-child{margin-bottom:0}
    .comparison-row .label{flex:1;text-align:center;font-size:11px;color:#666}
    .comparison-row .value{width:60px;text-align:center;font-size:16px;font-weight:700}
    .comparison-row .value.p1{color:var(--player1)}
    .comparison-row .value.p2{color:var(--player2)}
    .comparison-row .bar-container{flex:2;height:8px;background:#1a1a1f;border-radius:4px;overflow:hidden;display:flex}
    .comparison-row .bar{height:100%;transition:width .3s}
    .comparison-row .bar.p1{background:var(--player1)}
    .comparison-row .bar.p2{background:var(--player2)}
    
    .rally-tracker{background:linear-gradient(135deg,#0a1510,#0d1a15);border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid #1a3a2a}
    .rally-tracker h4{margin:0 0 10px 0;font-size:13px;color:var(--success)}
    .rally-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .rally-stat{text-align:center;background:#0a0a0c;padding:10px;border-radius:8px}
    .rally-stat .value{font-size:20px;font-weight:700;color:var(--success)}
    .rally-stat .label{font-size:10px;color:#666;margin-top:2px}
    
    .matchup-insights{background:#0d0d10;border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid #222}
    .matchup-insights h4{margin:0 0 10px 0;font-size:13px;color:var(--warning)}
    .insight{padding:8px 10px;margin-bottom:6px;background:#111;border-radius:6px;font-size:12px;border-left:3px solid var(--warning);color:#ccc}
    .insight:last-child{margin-bottom:0}
    .insight .p1-highlight{color:var(--player1);font-weight:600}
    .insight .p2-highlight{color:var(--player2);font-weight:600}
    .insight .highlight{color:var(--accent);font-weight:600}
    
    .shot-exchange{background:#0a0a0c;border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid #1a1a1f}
    .shot-exchange h4{margin:0 0 10px 0;font-size:13px;color:#888}
    .exchange-timeline{max-height:150px;overflow-y:auto}
    .exchange-item{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid #1a1a1f;font-size:11px}
    .exchange-item:last-child{border-bottom:none}
    .exchange-item .time{width:50px;color:#555}
    .exchange-item .player-indicator{width:24px;height:24px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:10px;margin-right:8px}
    .exchange-item .player-indicator.p1{background:var(--player1);color:#000}
    .exchange-item .player-indicator.p2{background:var(--player2);color:#000}
    .exchange-item .stroke-type{flex:1;color:#ccc}
    .exchange-item .speed{color:var(--success);width:60px;text-align:right}
    
    .chart-container{background:#0a0a0c;border-radius:8px;padding:12px;margin-bottom:12px;border:1px solid #1a1a1f}
    canvas{background:transparent;border-radius:6px}
    
    .tabs{display:flex;gap:4px;margin-bottom:12px;background:#0a0a0c;padding:4px;border-radius:8px}
    .tab{flex:1;padding:8px;text-align:center;background:transparent;color:#666;border-radius:6px;font-size:12px;cursor:pointer;transition:all .2s}
    .tab.active{background:var(--accent);color:#000}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    .status-bar{display:flex;align-items:center;gap:8px;margin-top:12px;padding:10px;background:#1a1a1f;border-radius:8px}
    .status-dot{width:10px;height:10px;border-radius:50%;background:#666}
    .status-dot.active{background:var(--success);animation:pulse 1.5s infinite}
    .status-dot.scanning{background:var(--accent);animation:pulse 0.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    
    .tracking-settings{background:#1a1a1f;border-radius:8px;padding:12px;margin-top:12px;border:1px solid #333}
    .tracking-settings h4{margin:0 0 10px 0;font-size:13px;color:var(--accent)}
    .setting-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .setting-row label{flex:1;font-size:12px;color:#999}
    .setting-row input[type="range"]{flex:2}
    .setting-row span{width:40px;font-size:11px;color:var(--accent)}
    
    button{cursor:pointer;border:none;padding:10px 16px;border-radius:6px;font-weight:600;transition:all .2s}
    .btn-primary{background:var(--accent);color:#000}
    .btn-primary:hover{background:#00c8d9}
    .btn-secondary{background:#222;color:#eee;border:1px solid #333}
    .btn-secondary:hover{background:#333}
    .btn-success{background:var(--success);color:#000}
    .btn-success:hover{background:#3de0a8}
    .btn-group{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    
    .muted{color:#97a0ac;font-size:13px}
    
    @media(max-width:900px){
      .wrap{flex-direction:column}
      .left{max-width:100%}
      #dashboard{width:100%;right:-100%}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div id="player-detect-modal">
    <div class="modal-content">
      <div id="scanning-state" class="scanning-state">
        <div class="spinner"></div>
        <h3>Scanning Video for Players...</h3>
        <p>Analyzing multiple frames to detect players</p>
        <div class="scan-progress" id="scan-progress">Initializing...</div>
      </div>
      
      <div id="detection-results" class="detection-results">
        <h2>üë• <span id="modal-title">Select Players to Track</span></h2>
        <p id="modal-desc">Click on players below or enter their tag letter to select.</p>
        
        <div class="video-preview-container">
          <video id="preview-video" muted></video>
          <canvas id="preview-overlay"></canvas>
        </div>
        
        <div class="player-tags-info">
          <h4>Detected Players (click to select):</h4>
          <div class="detected-players-list" id="detected-players-list"></div>
        </div>
        
        <div id="single-player-select" class="multi-player-select">
          <h4>Selected Player:</h4>
          <div class="player-select-row">
            <div class="player-label p1"><span class="dot"></span> Player</div>
            <input type="text" id="single-tag-input" class="p1" maxlength="1" placeholder="A" />
            <div class="player-name">
              <input type="text" id="single-name-input" placeholder="Player name (optional)" />
            </div>
          </div>
        </div>
        
        <div id="multi-player-select" class="multi-player-select" style="display:none">
          <h4>Select Two Players:</h4>
          <div class="player-select-row">
            <div class="player-label p1"><span class="dot"></span> Player 1</div>
            <input type="text" id="p1-tag-input" class="p1" maxlength="1" placeholder="A" />
            <div class="player-name">
              <input type="text" id="p1-name-input" placeholder="Name (optional)" />
            </div>
          </div>
          <div class="player-select-row">
            <div class="player-label p2"><span class="dot"></span> Player 2</div>
            <input type="text" id="p2-tag-input" class="p2" maxlength="1" placeholder="B" />
            <div class="player-name">
              <input type="text" id="p2-name-input" placeholder="Name (optional)" />
            </div>
          </div>
        </div>
        
        <div class="modal-actions">
          <button class="btn-secondary" id="rescan-btn">üîÑ Rescan</button>
          <button class="btn-secondary" id="cancel-detect-btn">Cancel</button>
          <button class="btn-success" id="confirm-players-btn">Start Analysis</button>
        </div>
      </div>
      
      <div id="no-players-state" class="no-players-detected" style="display:none">
        <div class="icon">üòï</div>
        <h4>No Players Detected</h4>
        <p>Could not detect players. You can manually specify player positions or try rescanning.</p>
        <div class="modal-actions" style="margin-top:20px">
          <button class="btn-primary" id="retry-scan-btn">Try Again</button>
          <button class="btn-success" id="manual-select-btn">Manual Selection</button>
          <button class="btn-secondary" id="cancel-no-players-btn">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div id="dash-toggle">üìä Analytics</div>
  <div id="dashboard" aria-hidden="true">
    <h2 id="dashboard-title">Session Dashboard</h2>
    <div class="small" id="dashboard-subtitle">Real-time analytics</div>

    <div class="tracked-players" id="tracked-players-display" style="display:none">
      <div class="tracked-player-card p1">
        <div class="header">
          <div class="tag" id="p1-tag-display">A</div>
          <div>
            <div class="name" id="p1-name-display">Player 1</div>
            <div class="position" id="p1-pos-display">Left Side</div>
          </div>
          <button class="change-btn" id="change-players-btn">Change</button>
        </div>
      </div>
      <div class="tracked-player-card p2">
        <div class="header">
          <div class="tag" id="p2-tag-display">B</div>
          <div>
            <div class="name" id="p2-name-display">Player 2</div>
            <div class="position" id="p2-pos-display">Right Side</div>
          </div>
        </div>
      </div>
    </div>

    <div class="tracked-player-card p1" id="single-player-display" style="display:none;margin-bottom:14px">
      <div class="header">
        <div class="tag" id="single-tag-display">A</div>
        <div>
          <div class="name" id="single-name-display">Player</div>
          <div class="position" id="single-pos-display">Position</div>
        </div>
        <button class="change-btn" id="change-single-btn">Change</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="comparison">Comparison</div>
      <div class="tab" data-tab="individual">Individual</div>
      <div class="tab" data-tab="matchup">Matchup</div>
    </div>

    <div id="tab-comparison" class="tab-content active">
      <div class="rally-tracker">
        <h4>üèì Rally Statistics</h4>
        <div class="rally-stats">
          <div class="rally-stat">
            <div class="value" id="current-rally">0</div>
            <div class="label">Current Rally</div>
          </div>
          <div class="rally-stat">
            <div class="value" id="longest-rally">0</div>
            <div class="label">Longest Rally</div>
          </div>
          <div class="rally-stat">
            <div class="value" id="total-exchanges">0</div>
            <div class="label">Total Exchanges</div>
          </div>
        </div>
      </div>

      <div class="comparison-section">
        <h4>üìä Head-to-Head</h4>
        <div class="comparison-row">
          <div class="value p1" id="p1-strokes">0</div>
          <div class="bar-container">
            <div class="bar p1" id="p1-strokes-bar" style="width:50%"></div>
            <div class="bar p2" id="p2-strokes-bar" style="width:50%"></div>
          </div>
          <div class="value p2" id="p2-strokes">0</div>
        </div>
        <div class="comparison-row"><div class="label">Total Strokes</div></div>

        <div class="comparison-row" style="margin-top:12px">
          <div class="value p1" id="p1-speed">0</div>
          <div class="bar-container">
            <div class="bar p1" id="p1-speed-bar" style="width:50%"></div>
            <div class="bar p2" id="p2-speed-bar" style="width:50%"></div>
          </div>
          <div class="value p2" id="p2-speed">0</div>
        </div>
        <div class="comparison-row"><div class="label">Avg Speed</div></div>

        <div class="comparison-row" style="margin-top:12px">
          <div class="value p1" id="p1-consistency">0%</div>
          <div class="bar-container">
            <div class="bar p1" id="p1-cons-bar" style="width:50%"></div>
            <div class="bar p2" id="p2-cons-bar" style="width:50%"></div>
          </div>
          <div class="value p2" id="p2-consistency">0%</div>
        </div>
        <div class="comparison-row"><div class="label">Consistency</div></div>

        <div class="comparison-row" style="margin-top:12px">
          <div class="value p1" id="p1-fh">0</div>
          <div class="bar-container">
            <div class="bar p1" id="p1-fh-bar" style="width:50%"></div>
            <div class="bar p2" id="p2-fh-bar" style="width:50%"></div>
          </div>
          <div class="value p2" id="p2-fh">0</div>
        </div>
        <div class="comparison-row"><div class="label">Forehand</div></div>

        <div class="comparison-row" style="margin-top:12px">
          <div class="value p1" id="p1-bh">0</div>
          <div class="bar-container">
            <div class="bar p1" id="p1-bh-bar" style="width:50%"></div>
            <div class="bar p2" id="p2-bh-bar" style="width:50%"></div>
          </div>
          <div class="value p2" id="p2-bh">0</div>
        </div>
        <div class="comparison-row"><div class="label">Backhand</div></div>
      </div>

      <div class="shot-exchange">
        <h4>üîÑ Recent Exchanges</h4>
        <div class="exchange-timeline" id="exchange-timeline">
          <div class="muted" style="padding:10px;text-align:center">No exchanges yet</div>
        </div>
      </div>
    </div>

    <div id="tab-individual" class="tab-content">
      <h3>Player 1 (<span id="ind-p1-tag">A</span>) Strokes</h3>
      <div class="chart-container">
        <canvas id="p1-stroke-chart" height="100"></canvas>
      </div>
      
      <h3>Player 2 (<span id="ind-p2-tag">B</span>) Strokes</h3>
      <div class="chart-container">
        <canvas id="p2-stroke-chart" height="100"></canvas>
      </div>

      <h3>Speed Comparison</h3>
      <div class="chart-container">
        <canvas id="speed-comparison-chart" height="120"></canvas>
      </div>
    </div>

    <div id="tab-matchup" class="tab-content">
      <div class="matchup-insights">
        <h4>üéØ Matchup Insights</h4>
        <div id="matchup-insights-list">
          <div class="insight">Play more rallies to generate insights...</div>
        </div>
      </div>

      <div class="comparison-section">
        <h4>üìà Dominance</h4>
        <div class="comparison-row">
          <div class="value p1" id="p1-dominance">50%</div>
          <div class="bar-container">
            <div class="bar p1" id="p1-dom-bar" style="width:50%"></div>
            <div class="bar p2" id="p2-dom-bar" style="width:50%"></div>
          </div>
          <div class="value p2" id="p2-dominance">50%</div>
        </div>
        <div class="comparison-row"><div class="label">Rally Control</div></div>
      </div>
    </div>

    <div class="btn-group" style="margin-top:18px">
      <button class="btn-primary" id="export-json">üìÑ JSON</button>
      <button class="btn-primary" id="export-pdf">üìë PDF</button>
      <button class="btn-secondary" id="reset-session">üîÑ Reset</button>
    </div>
  </div>

  <div class="wrap">
    <div class="left">
      <h1>üèì Table Tennis Analyzer</h1>
      <div class="controls">
        <input id="videoUpload" type="file" accept="video/*" />
        <div class="mode-toggle">
          <button id="single-mode-btn" class="active">Single</button>
          <button id="multi-mode-btn">Multi-Player</button>
        </div>
        <button id="start-analysis-btn" disabled>‚ñ∂Ô∏è Start</button>
        <button id="toggle-tracking">üéæ Ball: ON</button>
      </div>
      <div class="video-container">
        <video id="video" controls></video>
        <canvas id="overlay-canvas"></canvas>
      </div>
      
      <div class="status-bar">
        <div class="status-dot" id="status-dot"></div>
        <span id="status">Upload a video to begin - mp4 format only</span>
      </div>

      <div class="tracking-settings">
        <h4>üéæ Ball Detection</h4>
        <div class="setting-row">
          <label>Orange Sensitivity</label>
          <input type="range" id="orange-sens" min="0" max="100" value="50" />
          <span id="orange-sens-val">50</span>
        </div>
        <div class="setting-row">
          <label>White Sensitivity</label>
          <input type="range" id="white-sens" min="0" max="100" value="50" />
          <span id="white-sens-val">50</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    const CONFIG = {
      STROKE_COOLDOWN: 0.25,
      SPEED_THRESHOLD_MULT: 2.5,
      FPS: 30,
      BALL_TRACKING: { orangeSensitivity: 50, whiteSensitivity: 50, minBallSize: 15, maxBallSize: 60, trailLength: 20, searchRadius: 100 },
      PIXELS_TO_METERS: 0.003
    };

    const state = {
      isMultiPlayerMode: false,
      detectedPlayers: [],
      player1: { index: -1, tag: '', name: 'Player 1', position: '', centerX: 0.25, prevWrist: null, speedSamples: [], strokes: [], strokeDistribution: {}, lastStrokeTime: 0, consistency: 100 },
      player2: { index: -1, tag: '', name: 'Player 2', position: '', centerX: 0.75, prevWrist: null, speedSamples: [], strokes: [], strokeDistribution: {}, lastStrokeTime: 0, consistency: 100 },
      isPlayerSelected: false,
      currentRally: 0,
      longestRally: 0,
      totalExchanges: 0,
      lastStrokePlayer: null,
      exchanges: [],
      ballTrackingEnabled: true,
      ballTrajectory: [],
      lastBallPosition: null,
      prevFrameData: null,
      ballSpeeds: [],
      frameCount: 0,
      processingCanvas: null,
      processingCtx: null,
      isAnalyzing: false,
      videoLoaded: false,
      poseDetector: null,
      latestPoses: [],
      poseDetectorReady: false
    };

    const video = document.getElementById('video');
    const upload = document.getElementById('videoUpload');
    const statusEl = document.getElementById('status');
    const statusDot = document.getElementById('status-dot');
    const dashboard = document.getElementById('dashboard');
    const overlayCanvas = document.getElementById('overlay-canvas');
    const overlayCtx = overlayCanvas.getContext('2d');
    const playerDetectModal = document.getElementById('player-detect-modal');
    const scanningState = document.getElementById('scanning-state');
    const detectionResults = document.getElementById('detection-results');
    const noPlayersState = document.getElementById('no-players-state');
    const previewVideo = document.getElementById('preview-video');
    const previewOverlay = document.getElementById('preview-overlay');
    const previewOverlayCtx = previewOverlay.getContext('2d');
    const trackedPlayersDisplay = document.getElementById('tracked-players-display');
    const singlePlayerDisplay = document.getElementById('single-player-display');
    const startAnalysisBtn = document.getElementById('start-analysis-btn');
    const scanProgress = document.getElementById('scan-progress');

    state.processingCanvas = document.createElement('canvas');
    state.processingCtx = state.processingCanvas.getContext('2d', { willReadFrequently: true });

    // Charts
    const p1StrokeChart = new Chart(document.getElementById('p1-stroke-chart').getContext('2d'), {
      type: 'doughnut',
      data: { labels: ['FH Loop','BH Loop','FH Chop','BH Chop','Smash','Block'], datasets: [{ data: [0,0,0,0,0,0], backgroundColor: ['#00eaff','#00b8cc','#008899','#006677','#004455','#003344'], borderWidth: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    const p2StrokeChart = new Chart(document.getElementById('p2-stroke-chart').getContext('2d'), {
      type: 'doughnut',
      data: { labels: ['FH Loop','BH Loop','FH Chop','BH Chop','Smash','Block'], datasets: [{ data: [0,0,0,0,0,0], backgroundColor: ['#ff6b9d','#e0557d','#c0405d','#a02a3d','#80151d','#600000'], borderWidth: 0 }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    const speedCompChart = new Chart(document.getElementById('speed-comparison-chart').getContext('2d'), {
      type: 'line',
      data: { labels: [], datasets: [
        { label: 'P1', data: [], borderColor: '#00eaff', backgroundColor: 'rgba(0,234,255,0.1)', fill: true, tension: 0.4 },
        { label: 'P2', data: [], borderColor: '#ff6b9d', backgroundColor: 'rgba(255,107,157,0.1)', fill: true, tension: 0.4 }
      ]},
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#888', font: { size: 10 } } } }, scales: { x: { display: false }, y: { beginAtZero: true, grid: { color: '#1a1a1f' }, ticks: { color: '#666' } } } }
    });

    // Mode Toggle
    document.getElementById('single-mode-btn').addEventListener('click', () => {
      state.isMultiPlayerMode = false;
      document.getElementById('single-mode-btn').classList.add('active');
      document.getElementById('multi-mode-btn').classList.remove('active');
    });
    document.getElementById('multi-mode-btn').addEventListener('click', () => {
      state.isMultiPlayerMode = true;
      document.getElementById('multi-mode-btn').classList.add('active');
      document.getElementById('single-mode-btn').classList.remove('active');
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tab.dataset.tab}`).classList.add('active');
      });
    });

    document.getElementById('dash-toggle').addEventListener('click', () => dashboard.classList.toggle('open'));

    // Settings
    ['orange-sens', 'white-sens'].forEach(id => {
      document.getElementById(id).addEventListener('input', e => {
        document.getElementById(`${id}-val`).textContent = e.target.value;
        if (id === 'orange-sens') CONFIG.BALL_TRACKING.orangeSensitivity = parseInt(e.target.value);
        if (id === 'white-sens') CONFIG.BALL_TRACKING.whiteSensitivity = parseInt(e.target.value);
      });
    });

    const PLAYER_TAGS = ['A', 'B', 'C', 'D', 'E', 'F'];

    function showPlayerDetectionModal() {
      playerDetectModal.classList.add('active');
      scanningState.style.display = 'block';
      detectionResults.classList.remove('active');
      noPlayersState.style.display = 'none';
      
      if (state.isMultiPlayerMode) {
        document.getElementById('modal-title').textContent = 'Select Two Players';
        document.getElementById('modal-desc').textContent = 'Select two players for comparison analysis.';
        document.getElementById('single-player-select').style.display = 'none';
        document.getElementById('multi-player-select').style.display = 'block';
      } else {
        document.getElementById('modal-title').textContent = 'Select Player';
        document.getElementById('modal-desc').textContent = 'Select the player to analyze.';
        document.getElementById('single-player-select').style.display = 'block';
        document.getElementById('multi-player-select').style.display = 'none';
      }
      
      previewVideo.src = video.src;
      previewVideo.currentTime = Math.min(1, video.duration / 2);
      previewVideo.onloadeddata = () => {
        previewOverlay.width = previewVideo.videoWidth;
        previewOverlay.height = previewVideo.videoHeight;
        scanForPlayers();
      };
    }

    function hidePlayerDetectionModal() { playerDetectModal.classList.remove('active'); }

    async function initPoseDetector() {
      if (state.poseDetectorReady) return;
      
      scanProgress.textContent = 'Loading pose detection model...';
      
      try {
        // Load MediaPipe Pose
        await new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/pose.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
        
        scanProgress.textContent = 'Initializing pose detector...';
        
        state.poseDetector = new window.Pose({
          locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5.1675469404/${file}`
        });
        
        state.poseDetector.setOptions({
          modelComplexity: 1,
          smoothLandmarks: true,
          enableSegmentation: false,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });
        
        state.poseDetector.onResults((results) => {
          if (results.poseLandmarks) {
            state.latestPoses = [results.poseLandmarks];
          } else {
            state.latestPoses = [];
          }
        });
        
        // Wait for model to load
        await new Promise(r => setTimeout(r, 2000));
        state.poseDetectorReady = true;
        scanProgress.textContent = 'Pose detector ready!';
        
      } catch (err) {
        console.error('Failed to init pose detector:', err);
        scanProgress.textContent = 'Using fallback detection...';
      }
    }

    async function scanForPlayers() {
      statusDot.classList.add('scanning');
      state.detectedPlayers = [];
      
      try {
        await initPoseDetector();
        
        const duration = previewVideo.duration || 10;
        const scanTimes = [0.5, 1, 2, 3, 4, 5].filter(t => t < duration);
        const allDetections = [];
        
        for (let i = 0; i < scanTimes.length; i++) {
          const time = scanTimes[i];
          scanProgress.textContent = `Scanning frame ${i + 1}/${scanTimes.length}...`;
          
          previewVideo.currentTime = time;
          await new Promise(r => setTimeout(r, 400));
          
          // Send frame to pose detector
          if (state.poseDetector && state.poseDetectorReady) {
            try {
              await state.poseDetector.send({ image: previewVideo });
              await new Promise(r => setTimeout(r, 300));
              
              if (state.latestPoses.length > 0) {
                const pose = state.latestPoses[0];
                // Calculate center from nose or shoulders
                let centerX = 0.5, centerY = 0.5;
                const nose = pose[0];
                const leftShoulder = pose[11];
                const rightShoulder = pose[12];
                
                if (nose && nose.visibility > 0.5) {
                  centerX = nose.x;
                  centerY = nose.y;
                } else if (leftShoulder && rightShoulder) {
                  centerX = (leftShoulder.x + rightShoulder.x) / 2;
                  centerY = (leftShoulder.y + rightShoulder.y) / 2;
                }
                
                allDetections.push({
                  centerX,
                  centerY,
                  landmarks: pose,
                  time
                });
              }
            } catch (e) {
              console.warn('Pose detection error:', e);
            }
          }
        }
        
        scanProgress.textContent = 'Processing detections...';
        
        // Cluster detections by X position to identify unique players
        if (allDetections.length > 0) {
          // Sort by X position
          allDetections.sort((a, b) => a.centerX - b.centerX);
          
          // Cluster into player groups (players at similar X positions)
          const clusters = [];
          let currentCluster = [allDetections[0]];
          
          for (let i = 1; i < allDetections.length; i++) {
            const det = allDetections[i];
            const lastInCluster = currentCluster[currentCluster.length - 1];
            
            // If close in X position, same player
            if (Math.abs(det.centerX - lastInCluster.centerX) < 0.2) {
              currentCluster.push(det);
            } else {
              clusters.push(currentCluster);
              currentCluster = [det];
            }
          }
          clusters.push(currentCluster);
          
          // Take best detection from each cluster
          state.detectedPlayers = clusters.map((cluster, idx) => {
            // Average position
            const avgX = cluster.reduce((s, d) => s + d.centerX, 0) / cluster.length;
            const avgY = cluster.reduce((s, d) => s + d.centerY, 0) / cluster.length;
            // Use most recent landmarks
            const bestDet = cluster[cluster.length - 1];
            
            return {
              tag: PLAYER_TAGS[idx] || `P${idx + 1}`,
              centerX: avgX,
              centerY: avgY,
              position: avgX < 0.35 ? 'Left Side' : avgX > 0.65 ? 'Right Side' : 'Center',
              landmarks: bestDet.landmarks
            };
          });
        }
        
        // If no pose detections, try human detection by motion/color
        if (state.detectedPlayers.length === 0) {
          scanProgress.textContent = 'Trying alternative detection...';
          await detectPlayersByMotion();
        }
        
        if (state.detectedPlayers.length > 0) {
          showDetectionResults();
        } else {
          showNoPlayersState();
        }
        
      } catch (err) {
        console.error('Scan error:', err);
        showNoPlayersState();
      }
      
      statusDot.classList.remove('scanning');
    }

    async function detectPlayersByMotion() {
      // Fallback: assume standard table tennis setup with 2 players on opposite sides
      state.detectedPlayers = [
        { tag: 'A', centerX: 0.25, centerY: 0.5, position: 'Left Side', landmarks: null },
        { tag: 'B', centerX: 0.75, centerY: 0.5, position: 'Right Side', landmarks: null }
      ];
    }

    function showDetectionResults() {
      scanningState.style.display = 'none';
      noPlayersState.style.display = 'none';
      detectionResults.classList.add('active');
      
      const list = document.getElementById('detected-players-list');
      list.innerHTML = state.detectedPlayers.map((p, i) => `
        <div class="player-tag-item" data-index="${i}" data-tag="${p.tag}">
          <div class="player-tag-badge" style="background:${i === 0 ? 'var(--player1)' : i === 1 ? 'var(--player2)' : 'var(--accent)'}">${p.tag}</div>
          <div class="player-tag-desc">${p.position}</div>
        </div>
      `).join('');
      
      // Click to select
      list.querySelectorAll('.player-tag-item').forEach(item => {
        item.addEventListener('click', () => {
          const tag = item.dataset.tag;
          if (state.isMultiPlayerMode) {
            const p1Input = document.getElementById('p1-tag-input');
            const p2Input = document.getElementById('p2-tag-input');
            if (!p1Input.value || p1Input.value === tag) {
              p1Input.value = tag;
            } else if (!p2Input.value || p2Input.value === tag) {
              p2Input.value = tag;
            } else {
              p2Input.value = tag;
            }
          } else {
            document.getElementById('single-tag-input').value = tag;
          }
          updatePlayerTagSelection();
        });
      });
      
      drawPlayerTags();
      
      // Auto-fill first players
      if (state.detectedPlayers.length >= 1) {
        document.getElementById('single-tag-input').value = state.detectedPlayers[0].tag;
        document.getElementById('p1-tag-input').value = state.detectedPlayers[0].tag;
      }
      if (state.detectedPlayers.length >= 2) {
        document.getElementById('p2-tag-input').value = state.detectedPlayers[1].tag;
      }
      
      updatePlayerTagSelection();
    }

    function updatePlayerTagSelection() {
      const items = document.querySelectorAll('.player-tag-item');
      const p1Tag = state.isMultiPlayerMode ? document.getElementById('p1-tag-input').value : document.getElementById('single-tag-input').value;
      const p2Tag = state.isMultiPlayerMode ? document.getElementById('p2-tag-input').value : '';
      
      items.forEach(item => {
        item.classList.remove('selected');
        if (item.dataset.tag === p1Tag || item.dataset.tag === p2Tag) {
          item.classList.add('selected');
        }
      });
    }

    function showNoPlayersState() {
      scanningState.style.display = 'none';
      detectionResults.classList.remove('active');
      noPlayersState.style.display = 'block';
    }

    function drawPlayerTags() {
      const ctx = previewOverlayCtx;
      const w = previewOverlay.width, h = previewOverlay.height;
      ctx.clearRect(0, 0, w, h);
      
      state.detectedPlayers.forEach((p, i) => {
        const x = p.centerX * w;
        const y = Math.max(60, (p.centerY || 0.3) * h - 60);
        const color = i === 0 ? '#00eaff' : i === 1 ? '#ff6b9d' : '#4cffc1';
        
        // Draw vertical line
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Draw tag badge
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.roundRect(x - 25, y - 25, 50, 50, 10);
        ctx.fill();
        
        ctx.fillStyle = '#000';
        ctx.font = 'bold 28px Inter, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(p.tag, x, y);
        
        // Draw position label
        ctx.fillStyle = color;
        ctx.font = '14px Inter, Arial';
        ctx.fillText(p.position, x, y + 40);
        
        // Draw pose if available
        if (p.landmarks) {
          ctx.strokeStyle = `${color}aa`;
          ctx.lineWidth = 3;
          const lm = p.landmarks;
          
          // Draw arms
          [[12,14,16], [11,13,15]].forEach(arm => {
            ctx.beginPath();
            arm.forEach((idx, j) => {
              if (lm[idx] && lm[idx].visibility > 0.3) {
                const px = lm[idx].x * w, py = lm[idx].y * h;
                if (j === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
              }
            });
            ctx.stroke();
          });
          
          // Draw key points
          [11, 12, 13, 14, 15, 16].forEach(idx => {
            if (lm[idx] && lm[idx].visibility > 0.3) {
              ctx.beginPath();
              ctx.arc(lm[idx].x * w, lm[idx].y * h, 5, 0, Math.PI * 2);
              ctx.fillStyle = color;
              ctx.fill();
            }
          });
        }
      });
    }

    function confirmPlayerSelection() {
      if (state.isMultiPlayerMode) {
        const p1Tag = document.getElementById('p1-tag-input').value.toUpperCase().trim();
        const p2Tag = document.getElementById('p2-tag-input').value.toUpperCase().trim();
        
        let p1Data = state.detectedPlayers.find(p => p.tag === p1Tag);
        let p2Data = state.detectedPlayers.find(p => p.tag === p2Tag);
        
        // Allow manual tags
        if (!p1Data) p1Data = { tag: p1Tag || 'A', centerX: 0.25, position: 'Left Side' };
        if (!p2Data) p2Data = { tag: p2Tag || 'B', centerX: 0.75, position: 'Right Side' };
        
        if (p1Tag === p2Tag && p1Tag) { alert('Select two different players'); return; }
        
        state.player1 = { ...state.player1, index: 0, tag: p1Data.tag, name: document.getElementById('p1-name-input').value || `Player ${p1Data.tag}`, position: p1Data.position, centerX: p1Data.centerX };
        state.player2 = { ...state.player2, index: 1, tag: p2Data.tag, name: document.getElementById('p2-name-input').value || `Player ${p2Data.tag}`, position: p2Data.position, centerX: p2Data.centerX };
        
        document.getElementById('p1-tag-display').textContent = state.player1.tag;
        document.getElementById('p1-name-display').textContent = state.player1.name;
        document.getElementById('p1-pos-display').textContent = state.player1.position;
        document.getElementById('p2-tag-display').textContent = state.player2.tag;
        document.getElementById('p2-name-display').textContent = state.player2.name;
        document.getElementById('p2-pos-display').textContent = state.player2.position;
        document.getElementById('ind-p1-tag').textContent = state.player1.tag;
        document.getElementById('ind-p2-tag').textContent = state.player2.tag;
        
        trackedPlayersDisplay.style.display = 'flex';
        singlePlayerDisplay.style.display = 'none';
        document.getElementById('dashboard-title').textContent = 'Multi-Player Analysis';
        document.getElementById('dashboard-subtitle').textContent = `${state.player1.name} vs ${state.player2.name}`;
        
      } else {
        const tag = document.getElementById('single-tag-input').value.toUpperCase().trim() || 'A';
        let pData = state.detectedPlayers.find(p => p.tag === tag);
        if (!pData) pData = { tag, centerX: 0.5, position: 'Center' };
        
        state.player1 = { ...state.player1, index: 0, tag: pData.tag, name: document.getElementById('single-name-input').value || `Player ${pData.tag}`, position: pData.position, centerX: pData.centerX };
        
        document.getElementById('single-tag-display').textContent = state.player1.tag;
        document.getElementById('single-name-display').textContent = state.player1.name;
        document.getElementById('single-pos-display').textContent = state.player1.position;
        
        singlePlayerDisplay.style.display = 'block';
        trackedPlayersDisplay.style.display = 'none';
        document.getElementById('dashboard-title').textContent = 'Single Player Analysis';
        document.getElementById('dashboard-subtitle').textContent = state.player1.name;
      }
      
      state.isPlayerSelected = true;
      hidePlayerDetectionModal();
      statusEl.textContent = state.isMultiPlayerMode ? `Tracking ${state.player1.name} vs ${state.player2.name}` : `Tracking ${state.player1.name}`;
      statusDot.classList.add('active');
      video.play();
    }

    // Manual selection for when detection fails
    document.getElementById('manual-select-btn')?.addEventListener('click', () => {
      // Create default players at standard positions
      state.detectedPlayers = [
        { tag: 'A', centerX: 0.25, centerY: 0.5, position: 'Left Side', landmarks: null },
        { tag: 'B', centerX: 0.75, centerY: 0.5, position: 'Right Side', landmarks: null }
      ];
      showDetectionResults();
    });

    startAnalysisBtn.addEventListener('click', () => { if (state.videoLoaded) showPlayerDetectionModal(); });
    document.getElementById('confirm-players-btn').addEventListener('click', confirmPlayerSelection);
    document.getElementById('rescan-btn').addEventListener('click', () => { scanningState.style.display = 'block'; detectionResults.classList.remove('active'); scanForPlayers(); });
    document.getElementById('cancel-detect-btn').addEventListener('click', hidePlayerDetectionModal);
    document.getElementById('retry-scan-btn').addEventListener('click', () => { scanningState.style.display = 'block'; noPlayersState.style.display = 'none'; scanForPlayers(); });
    document.getElementById('cancel-no-players-btn').addEventListener('click', hidePlayerDetectionModal);
    document.getElementById('change-players-btn').addEventListener('click', () => { video.pause(); state.isPlayerSelected = false; showPlayerDetectionModal(); });
    document.getElementById('change-single-btn').addEventListener('click', () => { video.pause(); state.isPlayerSelected = false; showPlayerDetectionModal(); });
    
    ['single-tag-input', 'p1-tag-input', 'p2-tag-input'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', e => { e.target.value = e.target.value.toUpperCase(); updatePlayerTagSelection(); });
    });

    upload.addEventListener('change', e => {
      const f = e.target.files?.[0];
      if (!f) return;
      video.src = URL.createObjectURL(f);
      state.videoLoaded = true;
      startAnalysisBtn.disabled = false;
      statusEl.textContent = 'Video loaded ‚Äî Click Start';
      resetSession();
    });

    video.addEventListener('loadedmetadata', () => { state.videoLoaded = true; startAnalysisBtn.disabled = false; });
    video.addEventListener('play', () => {
      if (!state.isPlayerSelected) { video.pause(); showPlayerDetectionModal(); return; }
      statusEl.textContent = state.isMultiPlayerMode ? `Analyzing: ${state.player1.name} vs ${state.player2.name}` : `Analyzing: ${state.player1.name}`;
      statusDot.classList.add('active');
      state.isAnalyzing = true;
      analyzeFrame();
    });
    video.addEventListener('pause', () => { statusEl.textContent = 'Paused'; statusDot.classList.remove('active'); });
    video.addEventListener('ended', () => { statusEl.textContent = 'Complete!'; statusDot.classList.remove('active'); state.isAnalyzing = false; });
    document.getElementById('toggle-tracking').addEventListener('click', e => { state.ballTrackingEnabled = !state.ballTrackingEnabled; e.target.textContent = `üéæ Ball: ${state.ballTrackingEnabled ? 'ON' : 'OFF'}`; });

    function classifyStroke(wrist, elbow, shoulder, prevWrist, velocity, position) {
      const dx = wrist.x - prevWrist.x, dy = wrist.y - prevWrist.y;
      let angle = 90;
      if (elbow && shoulder) {
        const v1 = { x: shoulder.x - elbow.x, y: shoulder.y - elbow.y }, v2 = { x: wrist.x - elbow.x, y: wrist.y - elbow.y };
        const dot = v1.x * v2.x + v1.y * v2.y, m1 = Math.sqrt(v1.x**2 + v1.y**2), m2 = Math.sqrt(v2.x**2 + v2.y**2);
        if (m1 > 0 && m2 > 0) angle = Math.acos(Math.min(1, Math.max(-1, dot/(m1*m2)))) * 180/Math.PI;
      }
      let side = position === 'Left Side' ? (dx > 0 ? 'FH' : 'BH') : position === 'Right Side' ? (dx < 0 ? 'FH' : 'BH') : (elbow && wrist.x > elbow.x ? 'FH' : 'BH');
      let type = velocity > 0.055 && angle > 110 ? 'Smash' : dy > 0.01 && Math.abs(dy) > Math.abs(dx) * 1.2 ? 'Chop' : velocity < 0.025 ? 'Block' : 'Loop';
      return `${side} ${type}`;
    }

    function processPlayerStroke(player, pose, currentTime, playerNum) {
      const wrist = pose[16] || pose[15], elbow = pose[14] || pose[13], shoulder = pose[12] || pose[11];
      if (!wrist || wrist.visibility < 0.3) return;
      
      if (player.prevWrist) {
        const dx = wrist.x - player.prevWrist.x, dy = wrist.y - player.prevWrist.y;
        const velocity = Math.sqrt(dx*dx + dy*dy);
        player.speedSamples.push(velocity * 1000);
        if (player.speedSamples.length > 100) player.speedSamples.shift();
        const avgSpeed = player.speedSamples.reduce((a,b)=>a+b,0) / player.speedSamples.length;
        
        if (velocity > Math.max(0.012, avgSpeed * CONFIG.SPEED_THRESHOLD_MULT / 1000) && currentTime - player.lastStrokeTime > CONFIG.STROKE_COOLDOWN) {
          const strokeType = classifyStroke(wrist, elbow, shoulder, player.prevWrist, velocity, player.position);
          player.strokes.push({ t: currentTime, type: strokeType, speed: velocity * 1000, player: playerNum });
          player.strokeDistribution[strokeType] = (player.strokeDistribution[strokeType] || 0) + 1;
          player.lastStrokeTime = currentTime;
          
          if (state.isMultiPlayerMode) {
            if (state.lastStrokePlayer !== null && state.lastStrokePlayer !== playerNum) { state.currentRally++; state.totalExchanges++; }
            else if (state.lastStrokePlayer === playerNum) { state.longestRally = Math.max(state.longestRally, state.currentRally); state.currentRally = 0; }
            state.lastStrokePlayer = playerNum;
            state.exchanges.unshift({ time: currentTime, player: playerNum, stroke: strokeType, speed: velocity * 1000 });
            if (state.exchanges.length > 50) state.exchanges.pop();
          }
          statusEl.textContent = `${player.name}: ${strokeType}`;
        }
        
        if (player.speedSamples.length > 10) {
          const recent = player.speedSamples.slice(-30), mean = recent.reduce((a,b)=>a+b,0)/recent.length;
          const variance = recent.reduce((s,v)=>s+(v-mean)**2,0)/recent.length;
          player.consistency = Math.max(0, Math.min(100, 100 - (mean > 0 ? (Math.sqrt(variance)/mean)*100 : 0)));
        }
      }
      player.prevWrist = { x: wrist.x, y: wrist.y };
    }

    class BallTracker {
      constructor() { this.kalman = { x: 0, y: 0, vx: 0, vy: 0, init: false }; }
      detect(current, prev, w, h) {
        if (!state.ballTrackingEnabled) return null;
        const candidates = [], data = current.data, prevData = prev?.data;
        const oSens = CONFIG.BALL_TRACKING.orangeSensitivity / 100, wSens = CONFIG.BALL_TRACKING.whiteSensitivity / 100;
        const blobs = new Map();
        for (let y = 0; y < h; y += 3) {
          for (let x = 0; x < w; x += 3) {
            const i = (y * w + x) * 4, r = data[i], g = data[i+1], b = data[i+2];
            const isOrange = r > 140 + (1-oSens)*80 && g > 40 && g < 170 && b < 100 && r > g;
            const isWhite = r > 190+(1-wSens)*50 && g > 190+(1-wSens)*50 && b > 190+(1-wSens)*50;
            let motion = true;
            if (prevData) motion = Math.abs(r-prevData[i]) + Math.abs(g-prevData[i+1]) + Math.abs(b-prevData[i+2]) > 10;
            if ((isOrange || isWhite) && motion) {
              const key = `${Math.floor(x/15)}_${Math.floor(y/15)}`;
              if (!blobs.has(key)) blobs.set(key, { sx: 0, sy: 0, n: 0, o: isOrange });
              const bl = blobs.get(key); bl.sx += x; bl.sy += y; bl.n++;
            }
          }
        }
        blobs.forEach(bl => { if (bl.n >= 5) candidates.push({ x: bl.sx/bl.n, y: bl.sy/bl.n, radius: Math.max(8, Math.sqrt(bl.n*9/Math.PI)), isOrange: bl.o, confidence: bl.n/40 }); });
        if (state.lastBallPosition && candidates.length > 0) {
          candidates.sort((a, b) => Math.sqrt((a.x-state.lastBallPosition.x)**2+(a.y-state.lastBallPosition.y)**2) - Math.sqrt((b.x-state.lastBallPosition.x)**2+(b.y-state.lastBallPosition.y)**2));
          if (Math.sqrt((candidates[0].x-state.lastBallPosition.x)**2+(candidates[0].y-state.lastBallPosition.y)**2) < 100) return this.filter(candidates[0]);
        }
        if (candidates.length > 0) { candidates.sort((a, b) => b.confidence - a.confidence); return this.filter(candidates[0]); }
        return null;
      }
      filter(m) {
        const k = this.kalman;
        if (!k.init) { k.x = m.x; k.y = m.y; k.vx = 0; k.vy = 0; k.init = true; return m; }
        const px = k.x + k.vx, py = k.y + k.vy;
        k.x = px + 0.6*(m.x-px); k.y = py + 0.6*(m.y-py);
        k.vx = (k.x-px)*0.8 + k.vx*0.2; k.vy = (k.y-py)*0.8 + k.vy*0.2;
        return { ...m, x: k.x, y: k.y };
      }
      reset() { this.kalman.init = false; }
    }
    const ballTracker = new BallTracker();

    async function analyzeFrame() {
      if (!video || video.paused || video.ended || !state.isPlayerSelected) { if (state.isAnalyzing) requestAnimationFrame(analyzeFrame); return; }
      state.frameCount++;
      const vw = video.videoWidth || 640, vh = video.videoHeight || 480;
      if (overlayCanvas.width !== vw) { overlayCanvas.width = vw; overlayCanvas.height = vh; state.processingCanvas.width = vw; state.processingCanvas.height = vh; }
      overlayCtx.clearRect(0, 0, vw, vh);
      
      try {
        state.processingCtx.drawImage(video, 0, 0);
        const frameData = state.processingCtx.getImageData(0, 0, vw, vh);
        
        // Ball tracking
        if (state.ballTrackingEnabled) {
          const ball = ballTracker.detect(frameData, state.prevFrameData, vw, vh);
          if (ball) {
            if (state.lastBallPosition) {
              const speed = Math.sqrt(((ball.x-state.lastBallPosition.x)*CONFIG.PIXELS_TO_METERS)**2+((ball.y-state.lastBallPosition.y)*CONFIG.PIXELS_TO_METERS)**2)*CONFIG.FPS*3.6;
              if (speed > 0 && speed < 200) { state.ballSpeeds.push(speed); if (state.ballSpeeds.length > 100) state.ballSpeeds.shift(); }
            }
            state.ballTrajectory.push({ x: ball.x, y: ball.y });
            if (state.ballTrajectory.length > 30) state.ballTrajectory.shift();
            state.lastBallPosition = ball;
            overlayCtx.beginPath(); overlayCtx.arc(ball.x, ball.y, ball.radius || 10, 0, Math.PI * 2);
            overlayCtx.strokeStyle = ball.isOrange ? '#ff8c00' : '#ff0'; overlayCtx.lineWidth = 3; overlayCtx.stroke();
            if (state.ballTrajectory.length > 1) {
              overlayCtx.beginPath(); overlayCtx.strokeStyle = 'rgba(255,200,0,0.4)'; overlayCtx.lineWidth = 2;
              state.ballTrajectory.forEach((p, i) => i === 0 ? overlayCtx.moveTo(p.x, p.y) : overlayCtx.lineTo(p.x, p.y));
              overlayCtx.stroke();
            }
          }
          state.prevFrameData = frameData;
        }
        
        // Pose detection - use every 2nd frame for performance
        if (state.poseDetector && state.poseDetectorReady && state.frameCount % 2 === 0) {
          try {
            await state.poseDetector.send({ image: video });
            
            const poses = state.latestPoses;
            if (poses && poses.length > 0) {
              const currentTime = video.currentTime || 0;
              const pose = poses[0];
              
              // Determine which player this pose belongs to based on X position
              const nose = pose[0];
              let poseX = 0.5;
              if (nose && nose.visibility > 0.3) {
                poseX = nose.x;
              } else {
                const ls = pose[11], rs = pose[12];
                if (ls && rs) poseX = (ls.x + rs.x) / 2;
              }
              
              // Assign to closest player
              const distToP1 = Math.abs(poseX - state.player1.centerX);
              const distToP2 = state.isMultiPlayerMode ? Math.abs(poseX - state.player2.centerX) : Infinity;
              
              if (distToP1 <= distToP2) {
                processPlayerStroke(state.player1, pose, currentTime, 1);
                drawPlayerOverlay(pose, vw, vh, '#00eaff', state.player1.tag);
              } else {
                processPlayerStroke(state.player2, pose, currentTime, 2);
                drawPlayerOverlay(pose, vw, vh, '#ff6b9d', state.player2.tag);
              }
            }
          } catch (e) { /* ignore pose errors during playback */ }
        }
        
        state.longestRally = Math.max(state.longestRally, state.currentRally);
        
      } catch (e) { console.warn('Frame error:', e); }
      
      requestAnimationFrame(analyzeFrame);
    }

    function drawPlayerOverlay(pose, w, h, color, tag) {
      if (!pose) return;
      overlayCtx.fillStyle = color;
      [11,12,13,14,15,16].forEach(i => { if (pose[i] && pose[i].visibility > 0.3) { overlayCtx.beginPath(); overlayCtx.arc(pose[i].x*w, pose[i].y*h, 5, 0, Math.PI*2); overlayCtx.fill(); } });
      overlayCtx.strokeStyle = `${color}aa`; overlayCtx.lineWidth = 3;
      [[12,14,16], [11,13,15]].forEach(arm => { overlayCtx.beginPath(); arm.forEach((i, idx) => { if (pose[i] && pose[i].visibility > 0.3) { if (idx === 0) overlayCtx.moveTo(pose[i].x*w, pose[i].y*h); else overlayCtx.lineTo(pose[i].x*w, pose[i].y*h); } }); overlayCtx.stroke(); });
      if (pose[0] && pose[0].visibility > 0.3) {
        const nx = pose[0].x * w, ny = Math.max(25, pose[0].y * h - 40);
        overlayCtx.fillStyle = color; overlayCtx.beginPath(); overlayCtx.roundRect(nx-12, ny-12, 24, 24, 4); overlayCtx.fill();
        overlayCtx.fillStyle = '#000'; overlayCtx.font = 'bold 14px Inter, Arial'; overlayCtx.textAlign = 'center'; overlayCtx.textBaseline = 'middle';
        overlayCtx.fillText(tag, nx, ny);
      }
    }

    function generateMatchupInsights() {
      const p1 = state.player1, p2 = state.player2, insights = [];
      if (p1.strokes.length < 5 || p2.strokes.length < 5) return ['Play more to generate insights...'];
      const p1Total = p1.strokes.length, p2Total = p2.strokes.length;
      const p1FH = Object.entries(p1.strokeDistribution).filter(([k])=>k.startsWith('FH')).reduce((s,[,v])=>s+v,0);
      const p2FH = Object.entries(p2.strokeDistribution).filter(([k])=>k.startsWith('FH')).reduce((s,[,v])=>s+v,0);
      if (p1Total > p2Total * 1.5) insights.push(`<span class="p1-highlight">${p1.name}</span> more active (${p1Total} vs ${p2Total})`);
      else if (p2Total > p1Total * 1.5) insights.push(`<span class="p2-highlight">${p2.name}</span> more active (${p2Total} vs ${p1Total})`);
      if (p1FH > p1Total * 0.7) insights.push(`<span class="p1-highlight">${p1.name}</span> favors forehand`);
      if (p2FH > p2Total * 0.7) insights.push(`<span class="p2-highlight">${p2.name}</span> favors forehand`);
      if (p1.consistency > p2.consistency + 15) insights.push(`<span class="p1-highlight">${p1.name}</span> more consistent`);
      else if (p2.consistency > p1.consistency + 15) insights.push(`<span class="p2-highlight">${p2.name}</span> more consistent`);
      if (state.longestRally > 10) insights.push(`Great rally: <span class="highlight">${state.longestRally} exchanges</span>`);
      return insights.length > 0 ? insights : ['Evenly matched!'];
    }

    function refreshUI() {
      const p1 = state.player1, p2 = state.player2;
      document.getElementById('current-rally').textContent = state.currentRally;
      document.getElementById('longest-rally').textContent = state.longestRally;
      document.getElementById('total-exchanges').textContent = state.totalExchanges;
      const p1Total = p1.strokes.length, p2Total = state.isMultiPlayerMode ? p2.strokes.length : 0, total = p1Total + p2Total || 1;
      document.getElementById('p1-strokes').textContent = p1Total;
      document.getElementById('p2-strokes').textContent = p2Total;
      document.getElementById('p1-strokes-bar').style.width = `${(p1Total/total)*100}%`;
      document.getElementById('p2-strokes-bar').style.width = `${(p2Total/total)*100}%`;
      const p1Avg = p1.speedSamples.length > 0 ? (p1.speedSamples.reduce((a,b)=>a+b,0)/p1.speedSamples.length).toFixed(0) : 0;
      const p2Avg = state.isMultiPlayerMode && p2.speedSamples.length > 0 ? (p2.speedSamples.reduce((a,b)=>a+b,0)/p2.speedSamples.length).toFixed(0) : 0;
      const maxSpd = Math.max(parseFloat(p1Avg), parseFloat(p2Avg)) || 1;
      document.getElementById('p1-speed').textContent = p1Avg;
      document.getElementById('p2-speed').textContent = p2Avg;
      document.getElementById('p1-speed-bar').style.width = `${(p1Avg/maxSpd)*50}%`;
      document.getElementById('p2-speed-bar').style.width = `${(p2Avg/maxSpd)*50}%`;
      document.getElementById('p1-consistency').textContent = `${Math.round(p1.consistency)}%`;
      document.getElementById('p2-consistency').textContent = `${Math.round(p2.consistency)}%`;
      const consTotal = p1.consistency + p2.consistency || 1;
      document.getElementById('p1-cons-bar').style.width = `${(p1.consistency/consTotal)*100}%`;
      document.getElementById('p2-cons-bar').style.width = `${(p2.consistency/consTotal)*100}%`;
      const p1FH = Object.entries(p1.strokeDistribution).filter(([k])=>k.startsWith('FH')).reduce((s,[,v])=>s+v,0);
      const p2FH = Object.entries(p2.strokeDistribution).filter(([k])=>k.startsWith('FH')).reduce((s,[,v])=>s+v,0);
      const fhTotal = p1FH + p2FH || 1;
      document.getElementById('p1-fh').textContent = p1FH;
      document.getElementById('p2-fh').textContent = p2FH;
      document.getElementById('p1-fh-bar').style.width = `${(p1FH/fhTotal)*100}%`;
      document.getElementById('p2-fh-bar').style.width = `${(p2FH/fhTotal)*100}%`;
      const p1BH = Object.entries(p1.strokeDistribution).filter(([k])=>k.startsWith('BH')).reduce((s,[,v])=>s+v,0);
      const p2BH = Object.entries(p2.strokeDistribution).filter(([k])=>k.startsWith('BH')).reduce((s,[,v])=>s+v,0);
      const bhTotal = p1BH + p2BH || 1;
      document.getElementById('p1-bh').textContent = p1BH;
      document.getElementById('p2-bh').textContent = p2BH;
      document.getElementById('p1-bh-bar').style.width = `${(p1BH/bhTotal)*100}%`;
      document.getElementById('p2-bh-bar').style.width = `${(p2BH/bhTotal)*100}%`;
      const p1Dom = total > 0 ? (p1Total / total) * 100 : 50;
      document.getElementById('p1-dominance').textContent = `${Math.round(p1Dom)}%`;
      document.getElementById('p2-dominance').textContent = `${Math.round(100 - p1Dom)}%`;
      document.getElementById('p1-dom-bar').style.width = `${p1Dom}%`;
      document.getElementById('p2-dom-bar').style.width = `${100 - p1Dom}%`;
      document.getElementById('exchange-timeline').innerHTML = state.exchanges.slice(0, 15).map(e => `<div class="exchange-item"><span class="time">${e.time.toFixed(2)}s</span><span class="player-indicator ${e.player === 1 ? 'p1' : 'p2'}">${e.player === 1 ? p1.tag : p2.tag}</span><span class="stroke-type">${e.stroke}</span><span class="speed">${e.speed.toFixed(0)}</span></div>`).join('') || '<div class="muted" style="padding:10px;text-align:center">No exchanges yet</div>';
      const p1Dist = p1.strokeDistribution;
      p1StrokeChart.data.datasets[0].data = [p1Dist['FH Loop']||0, p1Dist['BH Loop']||0, p1Dist['FH Chop']||0, p1Dist['BH Chop']||0, (p1Dist['FH Smash']||0)+(p1Dist['BH Smash']||0), (p1Dist['FH Block']||0)+(p1Dist['BH Block']||0)];
      p1StrokeChart.update('none');
      if (state.isMultiPlayerMode) {
        const p2Dist = p2.strokeDistribution;
        p2StrokeChart.data.datasets[0].data = [p2Dist['FH Loop']||0, p2Dist['BH Loop']||0, p2Dist['FH Chop']||0, p2Dist['BH Chop']||0, (p2Dist['FH Smash']||0)+(p2Dist['BH Smash']||0), (p2Dist['FH Block']||0)+(p2Dist['BH Block']||0)];
        p2StrokeChart.update('none');
      }
      speedCompChart.data.labels = p1.speedSamples.slice(-50).map((_, i) => i);
      speedCompChart.data.datasets[0].data = p1.speedSamples.slice(-50);
      speedCompChart.data.datasets[1].data = state.isMultiPlayerMode ? p2.speedSamples.slice(-50) : [];
      speedCompChart.update('none');
      if (state.isMultiPlayerMode) document.getElementById('matchup-insights-list').innerHTML = generateMatchupInsights().map(i => `<div class="insight">${i}</div>`).join('');
    }
    setInterval(refreshUI, 300);

    function resetSession() {
      state.player1 = { index: -1, tag: '', name: 'Player 1', position: '', centerX: 0.25, prevWrist: null, speedSamples: [], strokes: [], strokeDistribution: {}, lastStrokeTime: 0, consistency: 100 };
      state.player2 = { index: -1, tag: '', name: 'Player 2', position: '', centerX: 0.75, prevWrist: null, speedSamples: [], strokes: [], strokeDistribution: {}, lastStrokeTime: 0, consistency: 100 };
      state.isPlayerSelected = false;
      state.currentRally = 0; state.longestRally = 0; state.totalExchanges = 0; state.lastStrokePlayer = null; state.exchanges = [];
      state.ballTrajectory = []; state.lastBallPosition = null; state.prevFrameData = null; state.ballSpeeds = [];
      state.detectedPlayers = []; state.isAnalyzing = false;
      ballTracker.reset();
      trackedPlayersDisplay.style.display = 'none'; singlePlayerDisplay.style.display = 'none';
      statusDot.classList.remove('active', 'scanning');
      refreshUI();
    }

    document.getElementById('reset-session').addEventListener('click', () => { resetSession(); statusEl.textContent = 'Reset'; });
    document.getElementById('export-json').addEventListener('click', () => {
      const data = { mode: state.isMultiPlayerMode ? 'multi' : 'single', player1: { name: state.player1.name, tag: state.player1.tag, strokes: state.player1.strokes, distribution: state.player1.strokeDistribution, consistency: state.player1.consistency }, player2: state.isMultiPlayerMode ? { name: state.player2.name, tag: state.player2.tag, strokes: state.player2.strokes, distribution: state.player2.strokeDistribution, consistency: state.player2.consistency } : null, rally: { longest: state.longestRally, totalExchanges: state.totalExchanges }, exchanges: state.exchanges.slice(0, 100) };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `tt_${new Date().toISOString().slice(0,10)}.json`; a.click();
    });
    document.getElementById('export-pdf').addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      doc.setFontSize(20); doc.setTextColor(0, 200, 220);
      doc.text(state.isMultiPlayerMode ? 'Multi-Player Report' : 'Player Report', 40, 40);
      doc.setFontSize(10); doc.setTextColor(100); doc.text(`${new Date().toLocaleString()}`, 40, 60);
      let y = 90;
      doc.setFontSize(14); doc.setTextColor(0, 234, 255); doc.text(`${state.player1.name} (${state.player1.tag})`, 40, y); y += 20;
      doc.setFontSize(11); doc.setTextColor(0);
      doc.text(`Strokes: ${state.player1.strokes.length}`, 40, y); y += 15;
      doc.text(`Consistency: ${Math.round(state.player1.consistency)}%`, 40, y); y += 15;
      Object.entries(state.player1.strokeDistribution).forEach(([t, c]) => { doc.text(`  ${t}: ${c}`, 40, y); y += 12; }); y += 15;
      if (state.isMultiPlayerMode) {
        doc.setFontSize(14); doc.setTextColor(255, 107, 157); doc.text(`${state.player2.name} (${state.player2.tag})`, 40, y); y += 20;
        doc.setFontSize(11); doc.setTextColor(0);
        doc.text(`Strokes: ${state.player2.strokes.length}`, 40, y); y += 15;
        doc.text(`Consistency: ${Math.round(state.player2.consistency)}%`, 40, y); y += 15;
        Object.entries(state.player2.strokeDistribution).forEach(([t, c]) => { doc.text(`  ${t}: ${c}`, 40, y); y += 12; }); y += 15;
        doc.setFontSize(14); doc.setTextColor(76, 255, 193); doc.text('Rally Stats', 40, y); y += 20;
        doc.setFontSize(11); doc.setTextColor(0);
        doc.text(`Longest: ${state.longestRally}`, 40, y); y += 15;
        doc.text(`Total Exchanges: ${state.totalExchanges}`, 40, y);
      }
      doc.save(`tt_${new Date().toISOString().slice(0,10)}.pdf`);
    });

  </script>
</body>
</html>